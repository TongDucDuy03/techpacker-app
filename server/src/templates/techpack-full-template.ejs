<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tech Pack - <%= meta.productName || meta.articleName || 'Product' %>
  </title>
  <style>
    @page {
      size: A4 landscape;
      margin: 4mm 5mm;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      /* Ensure colors print correctly in PDF */
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    body {
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      background: white;
      margin: 0;
      padding: 0;
      margin-bottom: 8mm; /* Tạo khoảng trống cho footer (tối ưu) */
      /* Ensure colors print correctly in PDF */
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Image optimization for PDF size reduction */
    img {
      max-width: 100%;
      height: auto;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      object-fit: contain;
      page-break-inside: avoid;
    }

    /* Specific constraints for different image types */
    .logo-cell img,
    .page-header img {
      max-width: 400px;
      max-height: 200px;
    }

    .product-images img {
      max-width: 400px;
      max-height: 200px;
    }

    /* BOM thumbnail images - allow natural scaling */
    .bom-image img,
    .grid-item img {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    /* How to measure images - allow natural scaling */
    .how-to-measure img {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    /* Colorway images - allow natural scaling */
    .colorway-image img {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .container {
      max-width: 1200px;
      margin: 0;
      background: white;
    }

    /* Header chung cho mọi section */
    .page-header {
      background: white;
      /* border: 2px solid #000; */
      border: none;
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      margin-bottom: 2px;
      padding: 0;
      position: relative;
      z-index: 10;
      page-break-inside: avoid;
      page-break-after: avoid;
    }

    .page-header table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .page-header td {
      border: 1px solid #000;
      padding: 0px 8px 3px 8px;
      font-size: 14px;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      overflow: hidden;
      max-width: 0;white-space: normal;
    }

    .page-title {
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      padding: 0px 8px 4px 8px;
      border-bottom: 1px solid #000;
      background: #fff;
      line-height: 1.1;
    }

    .version-text {
      float: right;
      font-weight: normal;
    }

    .label {
      font-size: 14px;
      font-weight: bold;
      background: #e8e8e8;
      white-space: normal;
      width: 120px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      padding: 5px 6px;
    }

    .value {
      font-size: 14px; 
      background: #fff;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }

    .logo-cell {
      width: 80px;
      text-align: center;
      vertical-align: middle;
      background: #fff;
      border-left: 2px solid #000;
      padding: 0;
    }

    .product-cell {
      width: 80px;
      text-align: center;
      vertical-align: middle;
      background: #fff;
      border-left: 2px solid #000;
      padding: 0;
    }

    /* Override .page-header td (vertical-align: top) for image cells */
    .page-header td.product-cell,
    .page-header td.logo-cell {
      vertical-align: middle;
      padding: 0; /* tránh ảnh bị lệch do padding */
    }

    .product-images {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .product-images img {
      width: 100%;
      height: 100%;
      max-width: 95%;
      max-height: 95%; /* chừa 1 chút khoảng để không đè viền bảng */
      object-fit: contain; /* phóng to tối đa nhưng không méo */
      display: block;
      margin: 0;
    }

    /* Image box - reusable container for images that fit within a frame */
    .image-box {
      border: 1px solid #ddd;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
      margin: 0;
      margin-top: 3px;
      margin-bottom: 4px;
      /* Không set height cố định, để ảnh tự fit */
      display: inline-block;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }

    .image-box img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      /* Đảm bảo ảnh không tràn ra ngoài container */
      box-sizing: border-box;
      page-break-inside: avoid;
    }

    /* Giới hạn kích thước ảnh Design Sketch để không bị lẹm */
    .image-box--sketch {
      page-break-inside: avoid;
      overflow: visible;
      max-height: 400px;
      margin-bottom: 4px;
    }

    .image-box--sketch img {
      max-height: 380px;
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .image-box--empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
      min-height: 200px;
    }

    /* Section styles */
    .section {
      page-break-before: always;
      margin: 0;
      padding: 0;
      min-height: 0;
    }

    .section:first-child {
      page-break-before: auto;
      margin-top: 0;
      padding-top: 0;
      margin-bottom: 15px;
      padding-bottom: 10px;
    }

    /* Article Information section - keep header and design sketch together on page 1 */
    .section:first-child .page-header,
    .section:first-child .section-content,
    .section:first-child .info-grid {
      page-break-inside: avoid;
    }

    .section-content {
      padding: 0;
      margin: 0;
      clear: both;
      page-break-inside: avoid;
      page-break-after: avoid;
    }

    /* Construction Item Styles - Mỗi construction là 1 trang */
    .construction-item {
      display: flex;
      flex-direction: column;
      page-break-inside: avoid;
      page-break-after: avoid;
      page-break-before: avoid;
      overflow: visible;
      min-height: 0;
      height: auto;
    }

    .construction-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #333;
    }

    .construction-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
      text-align: center;
    }

    .construction-content {
      display: flex;
      flex-direction: row;
      flex: 1;
      gap: 20px;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      page-break-before: avoid !important;
      min-height: 0;
      max-height: none;
      overflow: visible;
    }

    .construction-image-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      page-break-before: avoid !important;
      min-width: 0;
      /* Giới hạn chiều cao khối ảnh để không tràn sang trang sau */
      max-height: 520px;
      overflow: hidden;
    }

    .construction-image {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: #f9f9f9;
      object-fit: contain;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      page-break-inside: avoid !important;
    }

    .construction-text {
      flex: 1;
      padding: 15px;
      background: #fff;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      page-break-before: avoid !important;
      overflow: visible;
      min-width: 0;
      max-height: none;
    }

    .construction-item-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin: 0 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }

    .construction-code {
      font-size: 12px;
      color: #666;
      margin: 5px 0;
    }

    .construction-description {
      font-size: 13px;
      line-height: 1.6;
      color: #333;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-left: 3px solid #007bff;
      border-radius: 4px;
    }

    .construction-section {
      margin: 15px 0;
    }

    .construction-label {
      font-size: 13px;
      color: #333;
      display: block;
      margin-bottom: 8px;
    }

    .construction-list {
      margin: 8px 0;
      padding-left: 25px;
      font-size: 12px;
      line-height: 1.6;
      color: #555;
    }

    .construction-list li {
      margin-bottom: 5px;
    }

    .construction-tips {
      margin: 15px 0;
      padding: 12px;
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      border-radius: 4px;
    }

    .construction-tips strong {
      font-size: 13px;
      color: #92400e;
      display: block;
      margin-bottom: 8px;
    }

    .construction-tips .construction-list {
      color: #78350f;
    }

    .construction-mistakes {
      margin: 15px 0;
      padding: 12px;
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      border-radius: 4px;
    }

    .construction-mistakes strong {
      font-size: 13px;
      color: #991b1b;
      display: block;
      margin-bottom: 8px;
    }

    .construction-mistakes .construction-list {
      color: #7f1d1d;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      margin: 0;
      margin-bottom: 4px;
      page-break-inside: avoid;
      page-break-after: avoid;
    }

    .info-item {
      border: 1px solid #ddd;
      padding: 6px;
      margin: 0;
      page-break-inside: avoid;
    }

    /* Colorways layout: 3 “cards” đều, có khoảng cách rõ ràng */
    .colorways-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin: 0;
      margin-bottom: 8px;
    }

    .colorway-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 10px;
      background: #fff;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .colorway-card-text {
      flex: 1;
      text-align: left;
    }

    .colorway-card-title {
      font-weight: 700;
      text-transform: uppercase;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .colorway-card-code {
      font-size: 13px;
      margin-bottom: 6px;
    }

    .colorway-card-image {
      flex-shrink: 0;
      text-align: right;
    }

    .colorway-card-image img {
      max-width: 140px;
      max-height: 110px;
      border: 1px solid #ccc;
      border-radius: 4px;
      object-fit: contain;
      display: block;
    }

    .info-item strong {
      display: block;
      color: #666;
      font-size: 14px;
      margin-bottom: 3px;
      text-transform: uppercase;
    }

    .info-item span {
      display: block;
      font-size: 14px;
    }

    /* Table styles */
    table {
      table-layout: fixed;
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      margin-bottom: 5px;
      font-size: 14px; /* Match body font-size for consistency */
    }

    th {
      background: #e8e8e8;
      padding: 6px;
      text-align: left;
      border: 1px solid #999;
      font-weight: bold;
      font-size: 14px;
      word-wrap: break-word;      /* Cắt từ dài */
      word-break: break-word;     /* Cho phép break giữa từ nếu cần */
      overflow-wrap: break-word;  /* Backup cho word-wrap */
      white-space: normal;        /* Cho phép xuống dòng */
      max-width: 0; 
    }

    td {
      padding: 6px;
      border: 1px solid #ccc;
      vertical-align: top;
      font-size: 14px;
      word-wrap: break-word;      /* Cắt từ dài */
      word-break: break-word;     /* Cho phép break giữa từ nếu cần */
      overflow-wrap: break-word;  /* Backup cho word-wrap */
      white-space: normal;        /* Cho phép xuống dòng */
      max-width: 0; 
    }

    .alt-row {
      /* background: #fafafa; */
      background: #e8e8e8;
    }

    .measurement-table td {
      text-align: center;
      font-size: 14px;
    }

    .measurement-table td:first-child,
    .measurement-table td:nth-child(2) {
      text-align: left;
      font-weight: bold;
    }

    .color-swatch {
      display: inline-block;
      width: 40px;
      height: 20px;
      border: 1px solid #999;
      vertical-align: middle;
      margin-right: 8px;
    }

    .notes {
      background: #fffacd;
      border-left: 3px solid #ffd700;
      padding: 8px 10px;
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.4;
    }

    .notes strong {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
    }

    .size-badge {
      background: #666;
      color: white;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 14px;
      display: inline-block;
      margin: 2px;
    }

    h3 {
      margin: 15px 0 10px 0;
      font-size: 14px;
      font-weight: bold;
      clear: both;
    }

    /* Đảm bảo tables không bị đè lên header */
    table:first-of-type {
      margin-top: 0;
    }

    /* Print-specific CSS với break-* chuẩn mới */
    @media print {
      /* Chuẩn mới thay cho page-break-* */
      .section {
        break-before: page;
        break-inside: auto;
      }

      .section:first-child {
        break-before: auto;
      }

      /* Colorways luôn kết thúc trang => Construction không dính lên */
      .section--colorways {
        break-after: page;
      }

      /* Construction item: đúng 1 break trước mỗi item, không double break */
      .construction-item {
        break-before: page !important;
        break-after: auto !important;
        break-inside: avoid !important;

        /* Bỏ toàn bộ vh/height cố định */
        min-height: 0 !important;
        height: auto !important;
        overflow: visible !important;

        /* Giữ flex để layout đúng, nhưng đảm bảo break hoạt động */
        display: flex !important;
        flex-direction: column !important;
      }

      .construction-content {
        /* Bỏ vh gây lỗi print */
        min-height: 0 !important;
        max-height: none !important;
        overflow: visible !important;

        break-inside: avoid !important;
      }

      .construction-text {
        overflow: visible !important; /* Tránh scroll container trong PDF */
        max-height: none !important;
      }

      .construction-image-wrapper {
        /* Vẫn cho phép hiển thị đầy đủ trong trang, nhưng giới hạn chiều cao cho bản in */
        max-height: 520px !important;
        overflow: hidden !important;
      }

      /* Đảm bảo thead lặp lại trên mỗi trang khi table bị ngắt trang */
      thead {
        display: table-header-group !important;
      }

      tbody {
        display: table-row-group !important;
      }

      tfoot {
        display: table-footer-group !important;
      }

      /* Đảm bảo header không bị ngắt trang */
      .page-header {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }

      /* Footer styles cho print */
      .pdf-footer {
        position: fixed !important;
        bottom: 0 !important;
      }
      
      body {
        margin-bottom: 8mm !important;
      }
      
      /* Đảm bảo content không đè lên footer */
      .section:last-of-type {
        margin-bottom: 9mm;
      }
    }

    /* ============================================
       FOOTER STYLES
       ============================================ */
    .pdf-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      font-family: Arial, sans-serif;
      font-size: 8pt;
      color: #1e293b;
      padding: 2px 6mm;
      border-top: 1px solid #333;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 9999;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      box-shadow: none;
    }

    .pdf-footer__left,
    .pdf-footer__center,
    .pdf-footer__right {
      flex: 1;
    }

    .pdf-footer__left {
      text-align: left;
      font-size: 8pt;
    }

    .pdf-footer__center {
      text-align: center;
      font-weight: 600;
      font-size: 8pt;
      color: #0f172a;
    }

    .pdf-footer__right {
      text-align: right;
      font-size: 8pt;
    }

    .pdf-footer strong {
      font-weight: 600;
      color: #334155;
    }
  </style>
</head>

<body>
  <div class="container">
    <%# Function để tạo header cho mỗi section %>
      <% function renderSectionHeader(sectionTitle) { %>
        <div class="page-header">
           <div class="page-title">
            <%= sectionTitle %>
            <!--  <span class="version-text">Version <%= meta.version || '1' %></span>-->
          </div> 
          <table>
            <colgroup>
              <col style="width: 8%;" />
              <col style="width: 10%;" />
              <col style="width: 19%;" />
              <col style="width: 12%;" />
              <col style="width: 21%;" />
              <col style="width: 11%;" />
              <col style="width: 11%;" />
              <col style="width: 8%;" />
            </colgroup>
            <tr>
              <td class="logo-cell" rowspan="4" style="width: 8%;">
                <% const hasLogo=images && images.companyLogo && images.companyLogo !=='—' &&
                  !images.companyLogo.includes('No Image'); %>
                  <% if (hasLogo) { %>
                    <img src="<%= images.companyLogo %>" alt="Company Logo"
                      style="max-width: 65px; max-height: 70px; object-fit: contain;display: block; margin: auto;" />
                    <% } else { %>
                      <strong style="font-size: 14px; display: block; text-align: center;">
                        <%= meta.brand || 'Company' %>
                      </strong>
                      <small style="font-size: 14px; display: block; text-align: center; color: #666;">Logo</small>
                      <% } %>
              </td>
              <td class="label" style="width: 10%;">Product Code</td>
              <td class="value" style="width: 19%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.articleCode || '-' %>
              </td>
              <td class="label" rowspan="2" style="width: 12%;">Description</td>
              <td class="value" rowspan="2" colspan="1" style="width: 21%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.description || meta.productDescription || '' %>
              </td>
              <td class="label" style="width: 11%;">Product Type</td>
              <td class="value" style="width: 11%;">
                <%= meta.category || 'Tops' %>
              </td>
              <td class="logo-cell product-cell" rowspan="4" style="width: 8%;">
                <div class="product-images">
                  <% const hasDesignSketch = images && images.coverImage && images.coverImage !== '—' &&
                    !images.coverImage.includes('No Image'); %>
                    <% if (hasDesignSketch) { %>
                      <img src="<%= images.coverImage %>" alt="Product" style="display: block; margin: auto;" />
                      <% } else { %>
                      <div style="width:100%; height:100%; border:1px solid #ccc; background:#f9f9f9;"></div>
                        <% } %>
                </div>
              </td>
            </tr>
            <tr>
              <td class="label">Product Name</td>
              <td class="value" style="width: 19%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.productName || meta.articleName || '-' %>
              </td>
              <td class="label" style="width: 11%;">Product Sub-Category</td>
              <td class="value" style="width: 11%;">
                <%= meta.productSubCategory || 'Short Sleeve' %>
              </td>
            </tr>
            <tr>
              <td class="label">Created On</td>
              <td class="value">
                <%= meta.createdAt || '-' %>
              </td>
              <td class="label" rowspan="2" style="width: 12%;">Material<br>Description</td>
              <td class="value" rowspan="2" colspan="1" style="width: 21%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.fabricDescription || '-' %>
                  <% if (meta.materialComposition) { %><br>
                    <%= meta.materialComposition %>
                      <% } %>
                        <% if (meta.supplier) { %><br>Supplier: <%= meta.supplier %>
                            <% } %>
              </td>
              <td class="label" style="width: 11%;">Season</td>
              <td class="value" style="width: 11%;">
                <%= meta.season || 'Active Development' %>
              </td>
            </tr>
            <tr>
              <td class="label">Last Modified</td>
              <td class="value">
                <%= meta.updatedAt || '-' %>
              </td>
              <td class="label" style="width: 11%;">Product Progress</td>
              <td class="value" style="width: 11%;">
                <%= meta.lifecycleStage || meta.status || 'Production' %>
              </td>
            </tr>
          </table>
        </div>
        <% } %>

          <%# 1. ARTICLE INFORMATION %>
            <div class="section" style="page-break-inside: avoid; page-break-after: avoid; page-break-before: avoid;">
               <% renderSectionHeader('Product Info'); %>
               <!-- Info Grid Section - placed before Design Sketch -->
                <div class="section-content" style="margin-top: 5px; margin-bottom: 8px;">
                  <div class="info-grid">
                    <div class="info-item">
                      <strong>Gender</strong>
                      <span>
                        <%= meta.gender || 'Unisex' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Product Type</strong>
                      <span>
                        <%= meta.productClass || meta.category || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Product Fit</strong>
                      <span>
                        <%= (meta.fitType && meta.fitType.trim()) ? meta.fitType : '—' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Technical Designer</strong>
                      <span>
                        <%= meta.designer || meta.technicalDesigner || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Brand</strong>
                      <span>
                        <%= meta.brand || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Target Market</strong>
                      <span>
                        <%= meta.targetMarket || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Ranking</strong>
                      <span>
                        <%= meta.pricePoint || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
                      <strong>Retail Price</strong>
                      <span>
                        <%= meta.retailPrice ? meta.retailPrice + ' ' + (meta.currency || 'USD' ) : '-' %>
                      </span>
                    </div>
                  </div>
                </div>
               <!-- Design Sketch Section - placed after info grid -->
                  <div style="margin-top: 5px; margin-bottom: 10px; width: 100%; overflow: visible;">
                    <!-- <div style="font-weight: 700; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #333; padding-bottom: 5px;">
                      DESIGN SKETCH
                    </div> -->
                    <% 
                      const designSketchImg = images && images.designSketch ? images.designSketch : (meta.designSketchUrl || '');
                     
                      const hasDesignSketch = designSketchImg && 
                        designSketchImg !== '—' && 
                        !designSketchImg.includes('No Image') &&
                        !designSketchImg.toLowerCase().includes('data:image/svg+xml') &&
                        designSketchImg.trim() !== '' &&
                        (designSketchImg.startsWith('data:image/jpeg') || 
                         designSketchImg.startsWith('data:image/png') ||
                         designSketchImg.startsWith('data:image/gif') ||
                         designSketchImg.startsWith('http'));
                    %>
                    <% if (hasDesignSketch) { %>
                      <div class="image-box image-box--sketch" style="page-break-inside: avoid; page-break-after: avoid;">
                        <img src="<%= designSketchImg %>" alt="Design Sketch" />
                      </div>
                    <% } else { %>
                      <div class="image-box image-box--sketch image-box--empty" style="page-break-inside: avoid; page-break-after: avoid;">
                        No design sketch
                      </div>
                    <% } %>
                  </div>
            </div>

            <%# 2. BILL OF MATERIALS %>
              <% if (bom && bom.parts && bom.parts.length> 0) { %>
                <div class="section">
                  <% renderSectionHeader('Bill of Materials'); %>
                    <div class="section-content">
                      <% const fabrics=[]; const trims=[]; const labels=[]; const packaging=[]; bom.parts.forEach(part=>
                        { part.items.forEach(item => { const partName = (part.partName || '').toLowerCase(); const
                        materialName = (item.materialName || '').toLowerCase(); if (partName.includes('fabric') ||
                        partName.includes('main') || materialName.includes('fabric')) { fabrics.push({...item, part:
                        part.partName}); } else if (partName.includes('label') || materialName.includes('label') ||
                        materialName.includes('hang')) { labels.push({...item, part: part.partName}); } else if
                        (partName.includes('packaging') || materialName.includes('polybag') ||
                        materialName.includes('clip') || materialName.includes('bag')) { packaging.push({...item, part:
                        part.partName}); } else { trims.push({...item, part: part.partName}); } }); }); %>

                        <% if (fabrics.length> 0) { %>
                          <h3>Fabric</h3>
                          <table>
                            <thead>
                              <tr>
                                <th style="width: 10%">Part</th>
                                <th style="width: 25%">Material Name</th>
                                <th style="width: 15%">Placement</th>
                                <th style="width: 10%">Size/ Width/ Usage</th>
                                <th style="width: 8%">Qty</th>
                                <th style="width: 8%">UOM</th>
                                <th style="width: 12%">Supplier</th>
                                <th style="width: 16%">Comments</th>
                                <th style="width: 10%">Color Code</th>
                              </tr>
                            </thead>
                            <tbody>
                              <% fabrics.forEach((item, idx)=> { %>
                                <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                  <td>
                                    <%= item.part || '-' %>
                                  </td>
                                  <td>
                                    <%= item.materialName || '-' %>
                                      <% if (item.sizeWidthUsage && item.sizeWidthUsage !=='—' ) { %><br /><small>
                                          <%= item.sizeWidthUsage %>
                                        </small>
                                        <% } %>
                                  </td>
                                  <td>
                                    <%= item.placement || 'None' %>
                                  </td>
                                  <td>
                                    <%= item.size || '-' %>
                                  </td>
                                  <td>
                                    <%= item.quantity || '0' %>
                                  </td>
                                  <td>
                                    <%= item.uom || 'Yards' %>
                                  </td>
                                  <td>
                                    <%= item.supplier || '-' %>
                                  </td>
                                  <td>
                                    <%= item.comments || '-' %>
                                  </td>
                                  <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                                    <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                                      <% if (item.colorCode) { %>
                                        <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                                        <% if (item.hexCode) { %><br/><% } %>
                                      <% } else if (item.color) { %>
                                        <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                                        <% if (item.pantone || item.hexCode) { %><br/><% } %>
                                        <% } %>
                                      <% if (!item.colorCode && item.pantone) { %>
                                        <span style="font-size: 14px;"><%= item.pantone %></span><br/>
                                        <% } %>
                                      <% if (item.hexCode) { %>
                                        <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                                        <span style="font-size: 14px;"><%= item.hexCode %></span>
                                      <% } %>
                                    <% } else { %>
                                      -
                                    <% } %>
                                  </td>
                                </tr>
                                <% }); %>
                            </tbody>
                          </table>
                          <% } %>

                            <% if (trims.length> 0) { %>
                              <h3>Trims</h3>
                              <table>
                                <thead>
                                  <tr>
                                    <th style="width: 10%">Part</th>
                                    <th style="width: 25%">Material Name</th>
                                    <th style="width: 15%">Placement</th>
                                    <th style="width: 10%">Size/ Width/ Usage</th>
                                    <th style="width: 8%">Qty</th>
                                    <th style="width: 8%">UOM</th>
                                    <th style="width: 12%">Supplier</th>
                                    <th style="width: 16%">Comments</th>
                                    <th style="width: 10%">Color Code</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% trims.forEach((item, idx)=> { %>
                                    <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                      <td>
                                        <%= item.part || '-' %>
                                      </td>
                                      <td>
                                        <%= item.materialName || '-' %>
                                      </td>
                                      <td>
                                        <%= item.placement || '-' %>
                                      </td>
                                      <td>
                                        <%= item.sizeWidthUsage || item.size || '-' %>
                                      </td>
                                      <td>
                                        <%= item.quantity || '0' %>
                                      </td>
                                      <td>
                                        <%= item.uom || 'Each' %>
                                      </td>
                                      <td>
                                        <%= item.supplier || '-' %>
                                      </td>
                                      <td>
                                        <%= item.comments || '-' %>
                                      </td>
                                      <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                                        <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                                          <% if (item.colorCode) { %>
                                            <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                                            <% if (item.hexCode) { %><br/><% } %>
                                          <% } else if (item.color) { %>
                                            <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                                            <% if (item.pantone || item.hexCode) { %><br/><% } %>
                                            <% } %>
                                          <% if (!item.colorCode && item.pantone) { %>
                                            <span style="font-size: 14px;"><%= item.pantone %></span><br/>
                                            <% } %>
                                          <% if (item.hexCode) { %>
                                            <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                                            <span style="font-size: 14px;"><%= item.hexCode %></span>
                                          <% } %>
                                        <% } else { %>
                                          -
                                        <% } %>
                                      </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                              </table>
                              <% } %>

                                <% if (labels.length> 0) { %>
                                  <h3>Labels</h3>
                                  <table>
                                    <thead>
                                      <tr>
                                        <th style="width: 12%">Part</th>
                                        <th style="width: 28%">Material</th>
                                        <th style="width: 22%">Placement</th>
                                        <th style="width: 8%">Qty</th>
                                        <th style="width: 8%">UOM</th>
                                        <th style="width: 22%">Comments</th>
                                        <th style="width: 12%">Color Code</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <% labels.forEach((item, idx)=> { %>
                                        <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                          <td>
                                            <%= item.part || '-' %>
                                          </td>
                                          <td>
                                            <%= item.materialName || '-' %>
                                          </td>
                                          <td>
                                            <%= item.placement || '-' %>
                                          </td>
                                          <td>
                                            <%= item.quantity || '1' %>
                                          </td>
                                          <td>
                                            <%= item.uom || 'Each' %>
                                          </td>
                                          <td>
                                            <%= item.comments || '-' %>
                                          </td>
                                          <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                                            <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                                              <% if (item.colorCode) { %>
                                                <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                                                <% if (item.hexCode) { %><br/><% } %>
                                              <% } else if (item.color) { %>
                                                <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                                                <% if (item.pantone || item.hexCode) { %><br/><% } %>
                                                <% } %>
                                              <% if (!item.colorCode && item.pantone) { %>
                                                <span style="font-size: 14px;"><%= item.pantone %></span><br/>
                                                <% } %>
                                              <% if (item.hexCode) { %>
                                                <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                                                <span style="font-size: 14px;"><%= item.hexCode %></span>
                                              <% } %>
                                            <% } else { %>
                                              -
                                            <% } %>
                                          </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                  </table>
                                  <% } %>

                                    <% if (packaging.length> 0) { %>
                                      <h3>Packaging</h3>
                                      <table>
                                        <thead>
                                          <tr>
                                            <th style="width: 12%">Part</th>
                                            <th style="width: 28%">Material</th>
                                            <th style="width: 10%">Qty</th>
                                            <th style="width: 10%">UOM</th>
                                            <th style="width: 18%">Supplier</th>
                                            <th style="width: 22%">Comments</th>
                                            <th style="width: 12%">Color Code</th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          <% packaging.forEach((item, idx)=> { %>
                                            <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                              <td>
                                                <%= item.part || '-' %>
                                              </td>
                                              <td>
                                                <%= item.materialName || '-' %>
                                              </td>
                                              <td>
                                                <%= item.quantity || '1' %>
                                              </td>
                                              <td>
                                                <%= item.uom || 'Each' %>
                                              </td>
                                              <td>
                                                <%= item.supplier || '-' %>
                                              </td>
                                              <td>
                                                <%= item.comments || '-' %>
                                              </td>
                                              <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                                                <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                                                  <% if (item.colorCode) { %>
                                                    <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                                                    <% if (item.hexCode) { %><br/><% } %>
                                                  <% } else if (item.color) { %>
                                                    <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                                                    <% if (item.pantone || item.hexCode) { %><br/><% } %>
                                                    <% } %>
                                                  <% if (!item.colorCode && item.pantone) { %>
                                                    <span style="font-size: 14px;"><%= item.pantone %></span><br/>
                                                    <% } %>
                                                  <% if (item.hexCode) { %>
                                                    <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                                                    <span style="font-size: 14px;"><%= item.hexCode %></span>
                                                  <% } %>
                                                <% } else { %>
                                                  -
                                                <% } %>
                                              </td>
                                            </tr>
                                            <% }); %>
                                        </tbody>
                                      </table>
                                      <% } %>
                    </div>
                </div>
                <% } %>

                  <%# 3. MEASUREMENTS %>
                    <% if (measurements && measurements.rows && measurements.rows.length> 0) { %>
                      <div class="section">
                        <% renderSectionHeader('Measurements - Comments'); %>
                          <div class="section-content">
                            <% if (measurements.sizeRange && measurements.sizeRange.length> 0) { %>
                              <div style="margin-bottom: 5px">
                                <strong>SIZE RANGE:</strong>
                                <% if (measurements.unit) { %>
                                  <span style="margin-left: 10px; color: #666; font-weight: normal;">(Unit: <%= measurements.unit %>)</span>
                                <% } %>
                                <div style="margin-top: 3px">
                                  <% const baseSize = measurements.baseSize; %>
                                  <% measurements.sizeRange.forEach(size=> { %>
                                    <span class="size-badge" style="<%= size === baseSize ? 'background: #79e5a5; color: #000;' : '' %>">
                                      <%= size %>
                                    </span>
                                    <% }); %>
                                </div>
                              </div>
                              <% } %>

                                <div style="overflow-x: auto">
                                  <table class="measurement-table">
                                    <thead>
                                      <tr>
                                        <th>POM Code</th>
                                        <th>Measurement Point</th>
                                        <th>-Tol</th>
                                        <th>+Tol</th>
                                        <% if (measurements.sizeRange) { measurements.sizeRange.forEach(size=> { %>
                                          <th>
                                            <%= size %>
                                          </th>
                                          <% }); } %>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <% measurements.rows.forEach((row, index)=> {
                                        const highlightCodes = ['BL20', 'BL21', 'AB11', 'AB30', 'AB70', 'AH10', 'SL10'];
                                        const shouldHighlight = highlightCodes.some(code =>
                                        row.pomCode?.includes(code));
                                        const baseSize = measurements.baseSize;
                                        %>
                                        <tr
                                          style="<%= shouldHighlight ? 'background: #ffe;' : (index % 2 === 1 ? 'background: #e8e8e8;' : '') %>">
                                          <td>
                                            <%= row.pomCode || '-' %>
                                          </td>
                                          <td>
                                            <%= row.pomName || '-' %>
                                          </td>
                                          <td>
                                            <%= row.minusToleranceFormatted || (row.minusTolerance !== undefined ? row.minusTolerance : '0') %>
                                          </td>
                                          <td>
                                            <%= row.plusToleranceFormatted || (row.plusTolerance !== undefined ? row.plusTolerance : '0') %>
                                          </td>
                                          <% if (measurements.sizeRange) { measurements.sizeRange.forEach(size=> { %>
                                            <td style="<%= size === baseSize ? 'background: #79e5a5;' : '' %>">
                                              <%= row.sizes?.[size] || '-' %>
                                            </td>
                                            <% }); } %>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                  </table>
                                </div>

                                <% if (measurements.notes || measurements.comments) { %>
                                  <div class="notes">
                                    <strong>NOTES:</strong>
                                    <%= measurements.notes || measurements.comments %>
                                  </div>
                                  <% } %>
                          </div>
                      </div>
                      <% } %>

                        <%# 3B. SAMPLE MEASUREMENT ROUNDS %>
                          <% if (sampleMeasurementRounds && sampleMeasurementRounds.length> 0) { %>
                            <% sampleMeasurementRounds.forEach((round, roundIndex)=> { %>
                              <div class="section">
                                <% renderSectionHeader('Sample Measurements - ' + round.name); %>
          <div class="section-content">
            <div class="info-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 5px">
              <div class="info-item">
                <strong>Measurement Date</strong>
                <span><%= round.measurementDate || ' -' %></span>
                              </div>
                              <div class="info-item">
                                <strong>Reviewer</strong>
                                <span>
                                  <%= round.reviewer || '-' %>
                                </span>
                              </div>

  </div>

  <% if (round.measurements && round.measurements.length> 0) { %>
    <div style="overflow-x: auto">
      <table class="measurement-table" style="font-size: 14px">
        <thead>
          <tr>
            <th style="width: 8%">POM</th>
            <th style="width: 12%">Point</th>
            <th style="width: 5%">-Tol</th>
            <th style="width: 5%">+Tol</th>
            <th style="width: 10%">Requested</th>
            <th style="width: 8%">Measured</th>
            <th style="width: 7%">Diff</th>
            <th style="width: 8%">Revised</th>
            <th style="width: 37%">Comments</th>
          </tr>
        </thead>
        <tbody>
          <% round.measurements.forEach((entry, idx)=> { %>
            <tr style="<%= idx % 2 === 1 ? 'background: #e8e8e8;' : '' %>">
              <td>
                <%= entry.pomCode || '-' %>
              </td>
              <td style="text-align: left">
                <%= entry.pomName || '-' %>
              </td>
                                          <td>
                                            <%= entry.toleranceMinusFormatted || entry.toleranceMinus || '0' %>
                                          </td>
                                          <td>
                                            <%= entry.tolerancePlusFormatted || entry.tolerancePlus || '0' %>
                                          </td>
              <td>
                <% const baseSize=measurements?.baseSize || 'M' ; %>
                  <%= entry.requested?.[baseSize] || '-' %>
              </td>
              <td>
                <%= entry.measured?.[baseSize] || '-' %>
              </td>
              <td style="<%= parseFloat(entry.diff?.[baseSize] || 0) > 0 ? 'color: red; font-weight: bold;' : '' %>">
                <%= entry.diff?.[baseSize] || '-' %>
              </td>
              <td>
                <%= entry.revised?.[baseSize] || '-' %>
              </td>
              <td style="text-align: left; font-size: 14px">
                <%= entry.comments?.[baseSize] || '-' %>
              </td>
            </tr>
            <% }); %>
        </tbody>
      </table>
    </div>
    <% } %>
      <% if (round.overallComments && round.overallComments !=='—' ) { %>
        <div class="notes" style="margin-top: 5px">
          <strong>OVERALL COMMENTS:</strong>
          <%- round.overallComments %>
        </div>
        <% } %>
          <% if (round.editorContent && round.editorContent.trim() !=='' ) { %>
            <div class="notes" style="margin-top: 5px">
              <strong>DETAILS:</strong>
              <%- round.editorContent %>
            </div>
            <% } %>
              </div>
              </div>
              <% }); %>
                <% } %>

                  <%# 4. COLORWAYS %>
                    <% if (colorways && colorways.length> 0) { %>
                      <div class="section section--colorways" style="page-break-inside: avoid !important; page-break-after: avoid !important;">
                        <% renderSectionHeader('Colorways'); %>
                          <div class="section-content" style="page-break-inside: avoid !important; page-break-after: avoid !important;">
                            <div class="colorways-grid" style="page-break-inside: avoid !important; page-break-after: avoid !important;">
                              <% colorways.forEach(color=> { %>
                                <div class="colorway-card" style="page-break-inside: avoid !important;">
                                  <div class="colorway-card-text">
                                    <div class="colorway-card-title">
                                      <%= color.name || 'Color' %>
                                    </div>
                                    <div class="colorway-card-code">
                                      Code: <%= color.code || '000' %>
                                    </div>
                                  </div>
                                  <% if (color.imageUrl && color.imageUrl !== '—' && !color.imageUrl.includes('No Image')) { %>
                                    <div class="colorway-card-image" style="page-break-inside: avoid !important;">
                                      <img src="<%= color.imageUrl %>" alt="Colorway Image" />
                                    </div>
                                  <% } %>
                                </div>
                              <% }); %>
                            </div>
                          </div>
                      </div>
                      <% } %>

                        <%# 5. CONSTRUCTION %>
                          <% if (howToMeasures && howToMeasures.length> 0) { %>
                            <% howToMeasures.forEach((item, index)=> { %>
                              <div class="section construction-item" style="page-break-inside: avoid !important; page-break-after: auto !important;">
                                <%# Tất cả các trang đều có header giống nhau %>
                                <% renderSectionHeader('Construction Details'); %>
                                
                                <div class="construction-content" style="page-break-inside: avoid !important; page-break-after: avoid !important; page-break-before: avoid !important;">
                                  <!-- Text Content Section - Bên trái -->
                                  <div class="construction-text" style="page-break-inside: avoid !important; page-break-after: avoid !important;">
                                    <h3 class="construction-item-title">
                                      <% 
                                        const stepNo = item.stepNumber || (index + 1);
                                        const rawNote = item.note && String(item.note).trim() && item.note !== '—' ? String(item.note).trim() : '';
                                        // Ưu tiên hiển thị NOTE ở vị trí tiêu đề (thay cho "Construction Point")
                                        const titleName = rawNote
                                          ? rawNote
                                          : ((item.pomName && item.pomName !== '—') ? item.pomName : '');
                                      %>
                                      <%= stepNo %><%= titleName ? '. ' + titleName : '' %>
                                    </h3>
                                    <%# Ẩn description và block NOTES theo yêu cầu (note đã được đưa lên tiêu đề) %>
                                    <% if (item.steps && item.steps.length > 0) { %>
                                      <div class="construction-section">
                                        <strong class="construction-label">Steps:</strong>
                                        <ol class="construction-list">
                                          <% item.steps.forEach(step => { %>
                                            <li><%= step %></li>
                                          <% }); %>
                                        </ol>
                                      </div>
                                    <% } %>
                                    <% if (item.tips && item.tips.length > 0) { %>
                                      <div class="construction-tips">
                                        <strong>💡 Tips:</strong>
                                        <ul class="construction-list">
                                          <% item.tips.forEach(tip => { %>
                                            <li><%= tip %></li>
                                          <% }); %>
                                        </ul>
                                      </div>
                                    <% } %>
                                    <% if (item.commonMistakes && item.commonMistakes.length > 0) { %>
                                      <div class="construction-mistakes">
                                        <strong>⚠️ Common Mistakes:</strong>
                                        <ul class="construction-list">
                                          <% item.commonMistakes.forEach(mistake => { %>
                                            <li><%= mistake %></li>
                                          <% }); %>
                                        </ul>
                                      </div>
                                    <% } %>
                                  </div>
                                  
                                  <!-- Image Section - Bên phải -->
                                  <% if (item.imageUrl) { %>
                                    <div class="construction-image-wrapper" style="page-break-inside: avoid !important; page-break-after: avoid !important; page-break-before: avoid !important;">
                                      <img src="<%= item.imageUrl %>" 
                                          alt="<%= item.pomName || 'Construction' %>"
                                          class="construction-image" 
                                          style="page-break-inside: avoid !important;" />
                                    </div>
                                  <% } else { %>
                                    <div class="construction-image-wrapper" style="background: #f9f9f9; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; page-break-inside: avoid !important; page-break-after: avoid !important;">
                                      <span style="color: #999; font-size: 14px;">No Image</span>
                                    </div>
                                  <% } %>
                                </div>
                              </div>
                            <% }); %>
                            <% } %>

                              <%# 6. PACKING %>
                                <% if (packingNotes && packingNotes !=='—' ) { %>
                                  <div class="section">
                                    <% renderSectionHeader('Labels - Packing'); %>
                                      <div class="section-content">
                                        <div
                                          style="background: #f8fafc; border: 1px solid #e1e7ee; border-radius: 6px; padding: 20px; font-size: 14px; line-height: 1.6;">
                                          <%- packingNotes %>
                                        </div>
                                      </div>
                                  </div>
                                  <% } %>
                                    <%# FOOTER %>
                                      <div class="pdf-footer">
                                        <div class="pdf-footer__left">
                                          Created by: <% 
                                            const designerName = meta?.technicalDesignerId || meta?.designer || meta?.technicalDesigner;
                                            const displayName = (designerName && String(designerName).trim() && designerName !== '—' && designerName !== '-') ? designerName : 'Technical Designer';
                                          %>
                                          <%= displayName %>
                                        </div>
                                        <div class="pdf-footer__center">
                                          By: iBC connecting
                                        </div>
                                        <div class="pdf-footer__right">
                                          Page <span class="pageNumber"></span> / <span class="totalPages"></span> 
                                        </div>
                                      </div>
                                      </div>
</body>

</html>