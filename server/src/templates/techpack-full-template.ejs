<!DOCTYPE html>
<html lang="<%= language || 'en' %>">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tech Pack - <%= meta.productName || meta.articleName || 'Product' %>
  </title>
  <style>
    @page {
      size: A4 landscape;
      margin: 4mm 5mm 15mm 5mm;
      /* Margin bottom 15mm để có chỗ cho footer, không quá lớn */
      counter-increment: page;
    }

    @page: first {
      counter-reset: page 1;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      /* Ensure colors print correctly in PDF */
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    body {
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 1.4;
      background: white;
      margin: 0;
      padding: 0;
      margin-bottom: 0;
      /* Không cần margin-bottom vì @page đã có margin */
      /* Ensure colors print correctly in PDF */
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Image optimization for PDF size reduction */
    img {
      max-width: 100%;
      height: auto;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      object-fit: contain;
      page-break-inside: avoid;
    }

    /* Specific constraints for different image types */
    .logo-cell img,
    .page-header img {
      max-width: 400px;
      max-height: 200px;
    }

    .product-images img {
      max-width: 400px;
      max-height: 200px;
    }

    /* BOM thumbnail images - allow natural scaling */
    .bom-image img,
    .grid-item img {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    /* How to measure images - allow natural scaling */
    .how-to-measure img {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    /* Colorway images - allow natural scaling */
    .colorway-image img {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .container {
      max-width: 1200px;
      margin: 0;
      background: white;
    }

    /* Header chung cho mọi section */
    .page-header {
      background: white;
      /* border: 2px solid #000; */
      border: none;
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      margin-bottom: 2px;
      padding: 0;
      position: relative;
      z-index: 10;
      page-break-inside: avoid;
      page-break-after: avoid;
    }

    .page-header table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .page-header td {
      border: 1px solid #000;
      padding: 0px 8px 3px 8px;
      font-size: 14px;
      vertical-align: top;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      overflow: hidden;
      max-width: 0;
      white-space: normal;
    }

    .page-title {
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      padding: 0px 8px 4px 8px;
      border-bottom: 1px solid #000;
      background: #fff;
      line-height: 1.1;
    }

    .version-text {
      float: right;
      font-weight: normal;
    }

    .label {
      font-size: 14px;
      font-weight: bold;
      background: #e8e8e8;
      white-space: normal;
      width: 120px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      padding: 5px 6px;
    }

    .value {
      font-size: 14px;
      background: #fff;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
    }

    .logo-cell {
      width: 80px;
      text-align: center;
      vertical-align: middle;
      background: #fff;
      border-left: 2px solid #000;
      padding: 0;
    }

    .product-cell {
      width: 80px;
      text-align: center;
      vertical-align: middle;
      background: #fff;
      border-left: 2px solid #000;
      padding: 0;
    }

    /* Override .page-header td (vertical-align: top) for image cells */
    .page-header td.product-cell,
    .page-header td.logo-cell {
      vertical-align: middle;
      padding: 0;
      /* tránh ảnh bị lệch do padding */
    }

    .product-images {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .product-images img {
      width: 100%;
      height: 100%;
      max-width: 95%;
      max-height: 95%;
      /* chừa 1 chút khoảng để không đè viền bảng */
      object-fit: contain;
      /* phóng to tối đa nhưng không méo */
      display: block;
      margin: 0;
    }

    /* Image box - reusable container for images that fit within a frame */
    .image-box {
      border: 1px solid #ddd;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
      margin: 0;
      margin-top: 3px;
      margin-bottom: 4px;
      /* Không set height cố định, để ảnh tự fit */
      display: inline-block;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
    }

    .image-box img {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      /* Đảm bảo ảnh không tràn ra ngoài container */
      box-sizing: border-box;
      page-break-inside: avoid;
    }

    /* Giới hạn kích thước ảnh Design Sketch để không bị lẹm và vừa với trang 1 */
    .image-box--sketch {
      page-break-inside: avoid;
      overflow: hidden;
      max-height: calc(100vh - 400px);
      /* Tự động điều chỉnh theo chiều cao trang */
      margin-bottom: 2px;
    }

    .image-box--sketch img {
      max-height: calc(100vh - 420px);
      /* Đảm bảo ảnh không tràn */
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
    }

    .image-box--empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
      min-height: 200px;
    }

    /* Section styles */
    .section {
      page-break-before: always;
      margin: 0;
      padding: 0;
      min-height: 0;
    }

    /* Article Information section - keep header and design sketch together on page 1 */
    .section:first-child {
      page-break-before: auto;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      margin-top: 0;
      padding-top: 0;
      margin-bottom: 0;
      /* Giảm margin để tiết kiệm không gian */
      padding-bottom: 0;
      /* Giảm padding để tiết kiệm không gian */
      max-height: calc(100vh - 20mm);
      /* Đảm bảo không vượt quá chiều cao trang trừ margin */
      overflow: hidden;
      /* Ẩn phần tràn nếu quá dài */
    }

    .section:first-child .page-header,
    .section:first-child .section-content,
    .section:first-child .info-grid {
      page-break-inside: avoid !important;
    }

    /* Colorways section - LUÔN bắt đầu ở trang mới, không được chia cắt, và LUÔN kết thúc bằng ngắt trang */
    .section--colorways {
      page-break-before: always !important;
      /* Bắt buộc bắt đầu ở trang mới */
      page-break-inside: avoid !important;
      /* Không được chia cắt */
      page-break-after: always !important;
      /* LUÔN kết thúc bằng ngắt trang để Construction bắt đầu ở trang mới */
      margin: 0;
      padding: 0;
    }

    .section-content {
      padding: 0;
      margin: 0;
      clear: both;
      page-break-inside: avoid;
      page-break-after: avoid;
    }

    /* Construction Item Styles - Mỗi construction là 1 trang */
    .construction-item {
      display: flex;
      flex-direction: column;
      page-break-inside: avoid !important;
      page-break-after: always !important;
      page-break-before: always !important;
      /* ❌ BỎ: min-height: calc(100vh - 20mm); */
      /* ❌ BỎ: height: calc(100vh - 20mm); */
      box-sizing: border-box;
      padding-bottom: 20px; /* Thêm padding để không bị sát đáy */
    }

    .construction-header {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #333;
    }

    .construction-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
      text-align: center;
    }

    .construction-content {
      display: flex;
      flex-direction: column;
      flex: 1;
      gap: 10px;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      page-break-before: avoid !important;
      min-height: 0;
      box-sizing: border-box;
      /* KHÔNG dùng overflow:hidden để ảnh có thể scale tự do */
    }

    .construction-image-wrapper {
      display: flex;
      align-items: center; /* ✅ ĐỔI từ stretch sang center */
      justify-content: center;
      width: 100%;
      flex: 0 1 auto; /* ✅ ĐỔI từ 1 1 auto sang 0 1 auto - không tự giãn */
      min-height: 200px; /* Chiều cao tối thiểu hợp lý */
      max-height: 650px; /* ✅ THÊM chiều cao tối đa */
    }

    .construction-image {
      width: 100% !important;
      height: 100% !important;
      /* Ép ảnh scale theo wrapper - KHÔNG dùng max-width/max-height làm trần */
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 5px;
      background: #f9f9f9;
      object-fit: contain !important;
      /* Giữ tỷ lệ, không crop, không méo - scale tối đa trong wrapper */
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      page-break-inside: avoid !important;
      display: block !important;
      margin: 0;
      /* KHÔNG dùng margin: auto vì dễ làm ảnh co lại */
    }

    .construction-text {
      padding: 8px 10px;
      background: #fff;
      page-break-inside: avoid !important;
      page-break-after: avoid !important;
      page-break-before: avoid !important;
      box-sizing: border-box;
      flex-shrink: 0;
      flex-grow: 0;
      /* Text section chỉ chiếm không gian thực tế cần thiết, KHÔNG mở rộng */
      /* Khi text ngắn → ảnh sẽ tự động scale lớn lên để lấp phần trống */
    }

    .construction-note {
      white-space: pre-wrap !important;     /* Giữ xuống dòng như UI */
      overflow-wrap: anywhere !important;   /* Cắt chuỗi dài */
      word-break: break-word !important;
      font-weight: 400 !important;
      line-height: 1.5;
      font-size: 14px;
      margin-top: 4px;
      margin-bottom: 8px;
    }

    .construction-item-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin: 0 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }

    .construction-code {
      font-size: 12px;
      color: #666;
      margin: 5px 0;
    }

    .construction-description {
      font-size: 13px;
      line-height: 1.6;
      color: #333;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-left: 3px solid #007bff;
      border-radius: 4px;
    }

    .construction-section {
      margin: 15px 0;
    }

    .construction-label {
      font-size: 13px;
      color: #333;
      display: block;
      margin-bottom: 8px;
    }

    .construction-list {
      margin: 8px 0;
      padding-left: 25px;
      font-size: 12px;
      line-height: 1.6;
      color: #555;
    }

    .construction-list li {
      margin-bottom: 5px;
    }

    .construction-tips {
      margin: 15px 0;
      padding: 12px;
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
      border-radius: 4px;
    }

    .construction-tips strong {
      font-size: 13px;
      color: #92400e;
      display: block;
      margin-bottom: 8px;
    }

    .construction-tips .construction-list {
      color: #78350f;
    }

    .construction-mistakes {
      margin: 15px 0;
      padding: 12px;
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      border-radius: 4px;
    }

    .construction-mistakes strong {
      font-size: 13px;
      color: #991b1b;
      display: block;
      margin-bottom: 8px;
    }

    .construction-mistakes .construction-list {
      color: #7f1d1d;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      margin: 0;
      margin-bottom: 4px;
      page-break-inside: avoid;
      page-break-after: avoid;
    }

    .info-item {
      border: 1px solid #ddd;
      padding: 6px;
      margin: 0;
      page-break-inside: avoid;
    }

    /* Colorways layout: 3 "cards" đều, có khoảng cách rõ ràng */
    .colorways-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin: 0;
      margin-bottom: 8px;
      page-break-inside: avoid !important;
      /* Không được chia cắt grid */
      page-break-after: avoid !important;
    }

    .colorway-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 12px 14px;
      /* Tăng padding để có thêm không gian */
      background: #fff;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      /* Tăng gap giữa text và ảnh */
      min-height: 200px;
      /* Đặt chiều cao tối thiểu để card cao hơn */
      page-break-inside: avoid !important;
      /* Không được chia cắt card */
    }

    .colorway-card-text {
      flex: 1;
      text-align: left;
      display: flex;
      flex-direction: column;
      justify-content: center;
      /* Căn giữa theo chiều dọc */
    }

    .colorway-card-title {
      font-weight: 700;
      text-transform: uppercase;
      font-size: 16px;
      /* Tăng font-size */
      margin-bottom: 6px;
      /* Tăng margin */
    }

    .colorway-card-code {
      font-size: 14px;
      /* Tăng font-size */
      margin-bottom: 8px;
      /* Tăng margin */
    }

    .colorway-card-image {
      flex-shrink: 0;
      text-align: right;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .colorway-card-image img {
      max-width: 180px;
      /* Tăng max-width */
      max-height: 165px;
      /* Tăng từ 110px lên 165px (gấp rưỡi) */
      border: 1px solid #ccc;
      border-radius: 4px;
      object-fit: contain;
      display: block;
    }

    .info-item strong {
      display: block;
      color: #666;
      font-size: 14px;
      margin-bottom: 3px;
      text-transform: uppercase;
    }

    .info-item span {
      display: block;
      font-size: 14px;
    }

    /* Table styles */
    table {
      table-layout: auto;
      /* Cho phép cột tự giãn theo nội dung */
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      margin-bottom: 5px;
      font-size: 14px;
      /* Match body font-size for consistency */
    }

    th {
      background: #e8e8e8;
      padding: 6px;
      text-align: left;
      border: 1px solid #999;
      font-weight: bold;
      font-size: 14px;
      /* KHÔNG BAO GIỜ cắt từ, chỉ xuống dòng tại khoảng trắng */
      word-break: keep-all;
      overflow-wrap: normal;
      /* Không wrap từ dài */
      white-space: normal;
      /* Cho phép xuống dòng tại khoảng trắng */
      hyphens: none;
      /* Không dùng gạch nối */
      min-width: 60px;
      /* Độ rộng tối thiểu, cột sẽ tự giãn theo nội dung */
    }

    td {
      padding: 6px;
      border: 1px solid #ccc;
      vertical-align: top;
      font-size: 14px;
      word-wrap: break-word;
      /* Cắt từ dài */
      word-break: break-word;
      /* Cho phép break giữa từ nếu cần */
      overflow-wrap: break-word;
      /* Backup cho word-wrap */
      white-space: normal;
      /* Cho phép xuống dòng */
      max-width: 0;
    }

    .alt-row {
      /* background: #fafafa; */
      background: #e8e8e8;
    }

    .measurement-table td {
      text-align: center;
      font-size: 14px;
    }

    .measurement-table td:first-child,
    .measurement-table td:nth-child(2) {
      text-align: left;
      font-weight: bold;
    }

    .color-swatch {
      display: inline-block;
      width: 40px;
      height: 20px;
      border: 1px solid #999;
      vertical-align: middle;
      margin-right: 8px;
    }

    .notes {
      background: #fffacd;
      border-left: 3px solid #ffd700;
      padding: 8px 10px;
      margin: 8px 0;
      font-size: 14px;
      line-height: 1.4;
      page-break-before: avoid;
      /* Không tách khỏi phần trước (bảng) */
      page-break-inside: avoid;
      /* Không chia cắt nội dung notes */
    }

    .notes strong {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
    }

    /* PACKING layout - bắt chước Construction: 1 ảnh + 1 ghi chú cạnh nhau */
    .packing-layout {
      display: flex;
      flex-direction: row;
      gap: 20px;
      align-items: stretch;
      margin-bottom: 16px;
      page-break-inside: avoid;
    }

    .packing-layout__image {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 50%;
      max-height: 100%;
      overflow: hidden;
      box-sizing: border-box;
    }

    .packing-layout__image img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      background: #f9f9f9;
      page-break-inside: avoid;
      display: block;
      margin: 0 auto;
      box-sizing: border-box;
    }

    /* CSS cho phần Packing - Layout: ảnh trên (90%), chữ dưới (10%) */
    .pp .section-content {
      display: flex !important;
      flex-direction: column !important;
      min-height: calc(100vh - 20mm - 120px - 76px);
      /* Trừ header (~120px) và footer (~76px) và margins (~20mm) */
      box-sizing: border-box;
    }

    .pp .section-content > div {
      display: flex !important;
      flex-direction: column !important;
      flex: 1;
      min-height: 0;
      box-sizing: border-box;
    }

    /* Packing item - mỗi item = 1 trang */
    .pp.packing-item {
      display: flex;
      flex-direction: column;
      page-break-inside: avoid !important;
      page-break-after: always !important;
      min-height: calc(100vh - 20mm - 120px - 76px);
      box-sizing: border-box;
    }

    /* =========================
       PACKING (.pp) - FIX LAYOUT
       ========================= */

    /* 1) Reset rule cũ layout ngang - xóa max-width:50% */
    .pp .packing-layout__image {
      max-width: none !important;
      width: 100% !important;
    }

    /* Packing layout - đổi từ row sang column */
    .pp .packing-layout {
      display: flex !important;
      flex-direction: column !important;
      gap: 10px !important;
      flex: 1;
      min-height: 0;
      box-sizing: border-box;
    }

    /* Ảnh trong phần Packing - chiếm phần còn lại */
    .pp .packing-layout__image {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      min-height: 0;
      box-sizing: border-box;
    }

    .pp .packing-layout__image img {
      width: 100% !important;
      height: 100% !important;
      max-width: 100% !important;
      max-height: 100% !important;
      object-fit: contain !important;
      display: block !important;
      margin: 0 !important;
      page-break-inside: avoid !important;
      box-sizing: border-box;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 8px;
      background: #f9f9f9;
    }

    /* Text/Note trong phần Packing - chỉ cao theo nội dung */
    .pp .packing-layout__note {
      flex: 0 0 auto !important;
      overflow-y: auto;
      box-sizing: border-box;
      font-size: 14px;
      line-height: 1.6;
      color: #111827;
      background: #ffffff;
      border-radius: 6px;
      padding: 12px 14px;
      border-left: 3px solid #2563eb;
    }

    /* Packing layout note - chỉ áp dụng ngoài .pp để tránh conflict */
    body:not(.pp) .packing-layout__note {
      flex: 1;
      font-size: 14px;
      line-height: 1.6;
      color: #111827;
      background: #ffffff;
      border-radius: 6px;
      padding: 12px 14px;
      box-sizing: border-box;
      max-height: 100%;
      overflow: hidden;
      border-left: 3px solid #2563eb;
      /* giống style note construction */
    }

    @media print {
      .pp .packing-layout {
        break-inside: avoid;
        page-break-inside: avoid;
      }
    }

    /* Ảnh content cần xử lý anti-waste (construction, notes) */
    .content-image {
      max-width: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      page-break-inside: avoid;
      display: block;
      margin: 10px auto;
      /* Sẽ được scale động bởi JavaScript dựa trên remainingHeight */
    }

    /* Giới hạn kích thước ảnh trong notes để tránh bị cắt trang */
    /* LƯU Ý: KHÔNG áp dụng rule này cho PACKING (.pp) nữa,
       để phần Packing export đúng y như nội dung nhập (WYSIWYG) */
    .notes img {
      max-width: 100%;
      /* Tính toán max-height dựa trên viewport height trừ header/footer/margins */
      /* A4 landscape: height=210mm ≈ 794px, margin=4mm+15mm=19mm ≈ 72px, header≈80px, footer≈20mm≈76px */
      /* Usable height ≈ 794 - 72 - 80 - 76 = 566px */
      /* Nhưng cần tính remainingHeight động, nên dùng calc(100vh - X) */
      max-height: calc(100vh - 200px);
      /* Ước tính, sẽ được điều chỉnh bởi JavaScript */
      width: auto;
      height: auto;
      object-fit: contain;
      page-break-inside: avoid;
      page-break-before: avoid;
      /* Ưu tiên không tách khỏi content trước */
      display: block;
      margin: 10px auto;
    }

    /* Khi trang còn nhiều khoảng trống (>40%), scale ảnh để vừa */
    @media print {
      .notes img {
        /* Trong print mode, sử dụng max-height động hơn */
        max-height: calc(100vh - 180px) !important;
        page-break-before: avoid !important;
      }
    }

    .size-badge {
      background: #666;
      color: white;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 14px;
      display: inline-block;
      margin: 2px;
    }

    h3 {
      margin: 15px 0 10px 0;
      font-size: 14px;
      font-weight: bold;
      clear: both;
    }

    /* Đảm bảo tables không bị đè lên header */
    table:first-of-type {
      margin-top: 0;
    }

    /* Print-specific CSS với break-* chuẩn mới */
    @media print {

      /* Chuẩn mới thay cho page-break-* */
      .section {
        break-before: page;
        break-inside: auto;
      }

      .section:first-child {
        break-before: auto;
      }

      /* Colorways LUÔN bắt đầu ở trang mới, không được chia cắt, và LUÔN kết thúc bằng ngắt trang */
      .section--colorways {
        break-before: page !important;
        /* Bắt buộc bắt đầu ở trang mới */
        break-inside: avoid !important;
        /* Không được chia cắt */
        break-after: page !important;
        /* LUÔN kết thúc bằng ngắt trang để Construction bắt đầu ở trang mới */
      }

      .colorways-grid {
        break-inside: avoid !important;
        /* Không được chia cắt grid */
      }

      .colorway-card {
        break-inside: avoid !important;
        /* Không được chia cắt card */
      }

      /* Construction item: mỗi item = 1 trang, không trang trống, LUÔN bắt đầu ở trang mới */
      .construction-item {
        break-inside: avoid !important;
        break-after: page !important;
        /* Luôn kết thúc trang sau mỗi item */
        break-before: page !important;
        /* LUÔN bắt đầu ở trang mới (kể cả item đầu tiên) */
        /* Không dùng 100vh ở đây, chiều cao sẽ được override bằng mm ở block cuối CSS */
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      .construction-content {
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
        break-inside: avoid !important;
        box-sizing: border-box !important;
        /* KHÔNG dùng overflow:hidden để ảnh có thể scale tự do */
        flex: 1 !important;
        min-height: 0 !important;
      }

      .construction-image-wrapper {
        width: 100% !important;
        flex: 1 1 auto !important;
        /* Chiếm TẤT CẢ không gian còn lại sau khi text đã chiếm phần của nó */
        min-height: 0 !important;
        /* Quan trọng: cho phép flex shrink */
        max-height: none !important;
        break-inside: avoid !important;
        box-sizing: border-box !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .construction-image {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        object-fit: contain !important;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        background: #f9f9f9;
      }

      .construction-text {
        flex-shrink: 0 !important;
        flex-grow: 0 !important;
        /* Text section chỉ chiếm không gian thực tế cần thiết, KHÔNG mở rộng */
        /* Khi text ngắn → ảnh sẽ tự động scale lớn lên để lấp phần trống */
      }

      .construction-text {
        break-inside: avoid !important;
      }

      /* Packing item - mỗi item = 1 trang */
      .pp.packing-item {
        break-inside: avoid !important;
        break-after: page !important;
        break-before: page !important;
        min-height: calc(100vh - 20mm) !important;
        height: calc(100vh - 20mm) !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      /* Packing item đầu tiên - không break-before để tránh trang trống */
      .pp.packing-item:first-of-type {
        break-before: auto !important;
        page-break-before: auto !important;
      }

      /* =========================
         PACKING (.pp) - FIX LAYOUT PRINT
         ========================= */

      /* Packing item = full page usable height */
      .pp.packing-item {
        height: calc(100vh - 20mm) !important;
        min-height: calc(100vh - 20mm) !important;
        display: flex !important;
        flex-direction: column !important;
      }

      /* Vùng content phải là flex column và có chiều cao thật */
      .pp .section-content {
        flex: 1 !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      .pp .section-content > div {
        flex: 1 !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      /* Packing layout: ảnh ăn phần còn lại, note auto theo nội dung */
      .pp .packing-layout {
        flex: 1 !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      /* Ảnh chiếm phần còn lại (quan trọng nhất) */
      .pp .packing-layout__image {
        flex: 1 1 0 !important;     /* CHIẾM HẾT PHẦN CÒN LẠI */
        min-height: 0 !important;
        max-width: none !important;   /* kill max-width:50% */
        width: 100% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-sizing: border-box !important;
      }

      /* Ảnh fill wrapper */
      .pp .packing-layout__image img {
        width: 100% !important;
        height: 100% !important;
        max-height: 100% !important;
        object-fit: contain !important;
        display: block !important;
        break-inside: avoid !important;
        box-sizing: border-box !important;
      }

      /* Note: chỉ cao theo nội dung, không được flex:1 */
      .pp .packing-layout__note {
        flex: 0 0 auto !important;
        max-height: 28% !important;     /* giới hạn để ảnh luôn được to */
        overflow: visible !important;   /* hoặc auto nếu note dài - FIX: không để hidden làm mất note */
        display: block !important;
        box-sizing: border-box !important;
      }

      /* Đảm bảo thead lặp lại trên mỗi trang khi table bị ngắt trang */
      thead {
        display: table-header-group !important;
      }

      tbody {
        display: table-row-group !important;
      }

      tfoot {
        display: table-footer-group !important;
      }

      /* Đảm bảo header không bị ngắt trang */
      .page-header {
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }

      /* Đảm bảo notes (overallComments) không bị tách khỏi bảng */
      .notes {
        break-before: avoid !important;
        page-break-before: avoid !important;
        break-inside: avoid !important;
        page-break-inside: avoid !important;
      }

      /* Footer styles cho print */
      .pdf-footer {
        position: fixed !important;
        bottom: 0 !important;
      }

      body {
        margin-bottom: 8mm !important;
      }

      /* Đảm bảo content không đè lên footer */
      .section:last-of-type {
        margin-bottom: 9mm;
      }
    }

    /* ============================================
       HEADER STYLES
       ============================================ */
    .pdf-header {
      width: 100%;
      max-width: 100%;
      font-family: 'Roboto', 'Arial', 'Helvetica', 'DejaVu Sans', sans-serif;
      font-size: 10pt;
      color: #475569;
      padding: 0 0 0px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-sizing: border-box;
    }

    .pdf-header__brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pdf-header__title {
      font-weight: 500;
      color: #7b7c7e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10pt;
    }

    .pdf-header__subtitle {
      font-size: 9pt;
      color: #64748b;
      margin-top: 2px;
    }

    .pdf-header__logo img {
      max-height: 32px;
      max-width: 160px;
      object-fit: contain;
      display: block;
    }

    .pdf-header__meta {
      text-align: right;
      font-size: 9pt;
    }

    /* ============================================
       FOOTER STYLES
       ============================================ */
    .pdf-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 8pt;
      color: #1e293b;
      padding: 2px 6mm;
      border-top: 1px solid #333;
      background: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 9999;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      box-shadow: none;
      height: 20px;
      box-sizing: border-box;
    }

    .pdf-footer__left,
    .pdf-footer__center,
    .pdf-footer__right {
      flex: 1;
    }

    .pdf-footer__left {
      text-align: left;
      font-size: 8pt;
    }

    .pdf-footer__center {
      text-align: center;
      font-weight: 600;
      font-size: 8pt;
      color: #0f172a;
    }

    .pdf-footer__right {
      text-align: right;
      font-size: 8pt;
    }

    .pdf-footer strong {
      font-weight: 600;
      color: #334155;
    }

    /* Page number counter - sử dụng CSS counter */
    .page-number::before {
      content: counter(page);
    }

    .total-pages::before {
      content: counter(pages);
    }

    /* =========================
       PACKING - FILL ALL HEIGHT (NO WASTE)
       ========================= */

    /* 1) Không khóa chiều cao bằng calc(px) ở chế độ thường */
    .pp.packing-item {
      min-height: 0 !important;
      height: auto !important;
    }

    .pp .section-content {
      min-height: 0 !important;    /* kill: calc(100vh - ...px) */
      flex: 1 !important;
      display: flex !important;
      flex-direction: column !important;
    }

    /* div wrapper đang bọc itemHtml */
    .pp .section-content > div {
      flex: 1 !important;
      min-height: 0 !important;
      display: flex !important;
      flex-direction: column !important;
    }

    /* 2) packing-layout phải chiếm hết chiều cao còn lại */
    .pp .packing-layout {
      flex: 1 !important;
      min-height: 0 !important;
      height: 100% !important;
      display: flex !important;
      flex-direction: column !important;
    }

    /* 3) Ảnh phải flex-grow để ăn hết phần thừa */
    .pp .packing-layout__image {
      flex: 1 1 0 !important;
      min-height: 0 !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    /* Ảnh fill wrapper */
    .pp .packing-layout__image img {
      width: 100% !important;
      height: 100% !important;
      max-height: 100% !important;
      object-fit: contain !important;
    }

    /* Note chỉ cao theo nội dung */
    .pp .packing-layout__note {
      flex: 0 0 auto !important;
      max-height: none !important;
      overflow: visible !important;
    }

    /* 4) Print: ép packing item luôn full page usable */
    @media print {
      .pp.packing-item {
        height: calc(100vh - 20mm) !important;
        min-height: calc(100vh - 20mm) !important;
        display: flex !important;
        flex-direction: column !important;
      }
    }

    /* =========================
       PACKING - FIX GAP BOTTOM (PRINT)
       Use page mm instead of 100vh
       A4 landscape height = 210mm
       @page margin: top 4mm, bottom 15mm => usable = 191mm
       ========================= */
    @media print {
      /* Tránh reserve thêm khoảng trống toàn tài liệu (đặc biệt khi footer fixed) */
      body { margin-bottom: 0 !important; }
      .section:last-of-type { margin-bottom: 0 !important; }

      /* Khóa chiều cao mỗi trang PACKING theo đúng page box (usable = 191mm) */
      .pp.packing-item {
        height: 191mm !important;
        min-height: 191mm !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      /* Content ăn hết phần còn lại sau header */
      .pp .section-content {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      .pp .section-content > div {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      /* packing-layout phải full height */
      .pp .packing-layout {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
      }

      /* Ảnh ăn hết phần thừa => hết gap */
      .pp .packing-layout__image {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }

      .pp .packing-layout__image img {
        width: 100% !important;
        height: 100% !important;
        max-height: 100% !important;
        object-fit: contain !important;
      }

      /* Note chỉ theo nội dung */
      .pp .packing-layout__note {
        flex: 0 0 auto !important;
        max-height: none !important;
        overflow: visible !important;
      }

      /* =========================
         CONSTRUCTION - LIKE PACKING (NO WASTE)
         ========================= */

      /* Mỗi construction item = đúng 1 trang usable height */
      .construction-item {
        height: 191mm !important;
        min-height: 191mm !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
        padding-bottom: 0 !important;
      }

      /* container nội dung phải ăn hết phần còn lại sau header */
      .construction-content {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        box-sizing: border-box !important;
      }

      /* ẢNH phải ăn toàn bộ phần còn lại */
      .construction-image-wrapper {
        flex: 1 1 auto !important;
        min-height: 0 !important;
        max-height: none !important;
        width: 100% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-sizing: border-box !important;
      }

      /* Ảnh fill wrapper */
      .construction-image {
        width: 100% !important;
        height: 100% !important;
        max-width: 100% !important;
        max-height: 100% !important;
        object-fit: contain !important;
        box-sizing: border-box !important;
      }

      /* TEXT chỉ theo nội dung */
      .construction-text {
        flex: 0 0 auto !important;
        min-height: 0 !important;
        overflow: visible !important;
        box-sizing: border-box !important;
      }

      /* Note-only pages cho phần dư của note */
      .construction-notes-page{
        height: 191mm !important;
        min-height: 191mm !important;
        display: flex !important;
        flex-direction: column !important;
        break-before: page !important;
        break-after: page !important;
        box-sizing: border-box !important;
      }

      .construction-notes-content{
        flex: 1 1 auto !important;
        min-height: 0 !important;
        padding: 8px 10px;
        box-sizing: border-box;
      }

      /* cho phép note dài tự ngắt trang trong note-only pages */
      .construction-notes-content .construction-note{
        break-inside: auto !important;
        page-break-inside: auto !important;
      }
    }
  </style>
</head>

<body>
  <% const t = translations || {}; %>
  <div class="container">
    <%# Function để tạo header cho mỗi section %>
      <% function renderSectionHeader(sectionTitle) { %>
        <div class="page-header">
          <div class="page-title">
            <%= sectionTitle %>
        <!--  <span class="version-text">Version <%= meta.version || '1' %></span>-->
          </div>
          <table>
            <colgroup>
              <col style="width: 8%;" />
          <col style="width: 10%;" />
          <col style="width: 19%;" />
              <col style="width: 12%;" />
          <col style="width: 21%;" />
          <col style="width: 11%;" />
          <col style="width: 11%;" />
              <col style="width: 8%;" />
            </colgroup>
            <tr>
              <td class="logo-cell" rowspan="4" style="width: 8%;">
                <% const hasLogo=images && images.companyLogo && images.companyLogo !=='—' &&
                  !images.companyLogo.includes('No Image'); %>
                  <% if (hasLogo) { %>
            <img src="<%= images.companyLogo %>" alt="Company Logo" style="max-width: 65px; max-height: 70px; object-fit: contain;display: block; margin: auto;" />
                    <% } else { %>
            <strong style="font-size: 14px; display: block; text-align: center;">
                        <%= meta.brand || 'Company' %>
                      </strong>
            <small style="font-size: 14px; display: block; text-align: center; color: #666;">Logo</small>
                      <% } %>
              </td>
          <td class="label" style="width: 10%;"><%= t.productCode || 'Product Code' %></td>
          <td class="value" style="width: 19%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.articleCode || '-' %>
              </td>
          <td class="label" rowspan="2" style="width: 12%;"><%= t.description || 'Description' %></td>
          <td class="value" rowspan="2" colspan="1" style="width: 21%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.description || meta.productDescription || '' %>
              </td>
          <td class="label" rowspan="2" style="width: 11%; vertical-align: middle;"><%= t.productType || 'Product Type' %></td>
          <td class="value" rowspan="2" style="width: 11%; vertical-align: middle;">
                <%= meta.category || 'Tops' %>
              </td>
          <td class="logo-cell product-cell" rowspan="4" style="width: 8%;">
                <div class="product-images">
              <% const hasDesignSketch = images && images.coverImage && images.coverImage !== '—' &&
                    !images.coverImage.includes('No Image'); %>
                    <% if (hasDesignSketch) { %>
              <img src="<%= images.coverImage %>" alt="Product" style="display: block; margin: auto;" />
                      <% } else { %>
              <div style="width:100%; height:100%; border:1px solid #ccc; background:#f9f9f9;"></div>
                        <% } %>
                </div>
              </td>
            </tr>
            <tr>
          <td class="label"><%= t.productName || 'Product Name' %></td>
          <td class="value" style="width: 19%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.productName || meta.articleName || '-' %>
              </td>
            </tr>
            <tr>
          <td class="label"><%= t.createdOn || 'Created On' %></td>
              <td class="value">
                <%= meta.createdAt || '-' %>
              </td>
          <td class="label" rowspan="2" style="width: 12%;"><%= t.materialDescription || 'Material Description' %></td>
          <td class="value" rowspan="2" colspan="1" style="width: 21%; word-break: break-word; overflow-wrap: break-word;">
                <%= meta.fabricDescription || '-' %>
                  <% if (meta.materialComposition) { %><br>
                    <%= meta.materialComposition %>
                      <% } %>
            <% if (meta.supplier) { %><br><%= t.supplier || 'Supplier' %>: <%= meta.supplier %>
                            <% } %>
              </td>
          <td class="label" style="width: 11%;"><%= t.season || 'Season' %></td>
          <td class="value" style="width: 11%;">
                <%= meta.season || 'Active Development' %>
              </td>
            </tr>
            <tr>
          <td class="label"><%= t.lastModified || 'Last Modified' %></td>
              <td class="value">
                <%= meta.updatedAt || '-' %>
              </td>
          <td class="label" style="width: 11%;"><%= t.productProgress || 'Product Progress' %></td>
          <td class="value" style="width: 11%;">
                <%= meta.lifecycleStage || meta.status || 'Production' %>
              </td>
            </tr>
          </table>
        </div>
        <% } %>

          <%# 1. ARTICLE INFORMATION %>
    <div class="section" style="page-break-inside: avoid; page-break-after: avoid; page-break-before: avoid;">
      <% renderSectionHeader(t.productInfo || 'Product Info'); %>
      <!-- Info Grid Section - placed before Design Sketch -->
      <div class="section-content" style="margin-top: 2px; margin-bottom: 4px;">
                  <div class="info-grid">
                    <div class="info-item">
            <strong><%= t.gender || 'Gender' %></strong>
                      <span>
                        <%= meta.gender || 'Unisex' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.productType || 'Product Type' %></strong>
                      <span>
                        <%= meta.productClass || meta.category || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.productFit || 'Product Fit' %></strong>
                      <span>
              <%= (meta.fitType && meta.fitType.trim()) ? meta.fitType : '—' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.technicalDesigner || 'Technical Designer' %></strong>
                      <span>
                        <%= meta.designer || meta.technicalDesigner || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.brand || 'Brand' %></strong>
                      <span>
                        <%= meta.brand || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.targetMarket || 'Target Market' %></strong>
                      <span>
                        <%= meta.targetMarket || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.ranking || 'Ranking' %></strong>
                      <span>
                        <%= meta.pricePoint || '-' %>
                      </span>
                    </div>
                    <div class="info-item">
            <strong><%= t.retailPrice || 'Retail Price' %></strong>
                      <span>
                        <%= meta.retailPrice ? meta.retailPrice + ' ' + (meta.currency || 'USD' ) : '-' %>
                      </span>
                    </div>
                  </div>
                    </div>
      <!-- Design Sketch Section - placed after info grid -->
      <div style="margin-top: 2px; margin-bottom: 4px; width: 100%; overflow: hidden; max-height: calc(100vh - 350px);">
        <!-- <div style="font-weight: 700; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #333; padding-bottom: 5px;">
                      DESIGN SKETCH
                    </div> -->
        <% 
                      const designSketchImg = images && images.designSketch ? images.designSketch : (meta.designSketchUrl || '');
                     
                      const hasDesignSketch = designSketchImg && 
                        designSketchImg !== '—' && 
                        !designSketchImg.includes('No Image') &&
                        !designSketchImg.toLowerCase().includes('data:image/svg+xml') &&
                        designSketchImg.trim() !== '' &&
                        (designSketchImg.startsWith('data:image/jpeg') || 
                         designSketchImg.startsWith('data:image/png') ||
                         designSketchImg.startsWith('data:image/gif') ||
                         designSketchImg.startsWith('http'));
                    %>
        <% if (hasDesignSketch) { %>
        <div class="image-box image-box--sketch" style="page-break-inside: avoid; page-break-after: avoid;">
          <img src="<%= designSketchImg %>" alt="Design Sketch" />
                              </div>
        <% } else { %>
        <div class="image-box image-box--sketch image-box--empty" style="page-break-inside: avoid; page-break-after: avoid;">
          No design sketch
                          </div>
                          <% } %>
                </div>
            </div>

            <%# 2. BILL OF MATERIALS %>
              <% if (bom && bom.parts && bom.parts.length> 0) { %>
                <div class="section">
      <% renderSectionHeader(t.billOfMaterials || 'Bill of Materials'); %>
                    <div class="section-content">
                      <% const fabrics=[]; const trims=[]; const labels=[]; const packaging=[]; bom.parts.forEach(part=>
                        { part.items.forEach(item => { const partName = (part.partName || '').toLowerCase(); const
                        materialName = (item.materialName || '').toLowerCase(); if (partName.includes('fabric') ||
                        partName.includes('main') || materialName.includes('fabric')) { fabrics.push({...item, part:
                        part.partName}); } else if (partName.includes('label') || materialName.includes('label') ||
                        materialName.includes('hang')) { labels.push({...item, part: part.partName}); } else if
                        (partName.includes('packaging') || materialName.includes('polybag') ||
                        materialName.includes('clip') || materialName.includes('bag')) { packaging.push({...item, part:
                        part.partName}); } else { trims.push({...item, part: part.partName}); } }); }); %>

                        <% if (fabrics.length> 0) { %>
                          <h3>Fabric</h3>
                          <table>
                            <thead>
                              <tr>
              <th style="width: 10%"><%= t.part || 'Part' %></th>
              <th style="width: 25%"><%= t.materialName || 'Material Name' %></th>
              <th style="width: 15%"><%= t.placement || 'Placement' %></th>
              <th style="width: 10%"><%= t.sizeWidthUsage || 'Size/Width/Usage' %></th>
              <th style="width: 8%"><%= t.qty || 'Qty' %></th>
              <th style="width: 8%"><%= t.uom || 'UOM' %></th>
              <th style="width: 12%"><%= t.supplier || 'Supplier' %></th>
              <th style="width: 16%"><%= t.comments || 'Comments' %></th>
              <th style="width: 10%"><%= t.colorCode || 'Color Code' %></th>
                              </tr>
                            </thead>
                            <tbody>
                              <% fabrics.forEach((item, idx)=> { %>
                                <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                  <td>
                                    <%= item.part || '-' %>
                                  </td>
                                  <td>
                                    <%= item.materialName || '-' %>
                                      <% if (item.sizeWidthUsage && item.sizeWidthUsage !=='—' ) { %><br /><small>
                                          <%= item.sizeWidthUsage %>
                                        </small>
                                        <% } %>
                                  </td>
                                  <td>
                                    <%= item.placement || 'None' %>
                                  </td>
                                  <td>
                                    <%= item.size || '-' %>
                                  </td>
                                  <td>
                                    <%= item.quantity || '0' %>
                                  </td>
                                  <td>
                                    <%= item.uom || 'Yards' %>
                                  </td>
                                  <td>
                                    <%= item.supplier || '-' %>
                                  </td>
                                  <td>
                                    <%= item.comments || '-' %>
              </td>
              <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                <% if (item.colorCode) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                <% if (item.hexCode) { %><br /><% } %>
                <% } else if (item.color) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                <% if (item.pantone || item.hexCode) { %><br /><% } %>
                                        <% } %>
                <% if (!item.colorCode && item.pantone) { %>
                <span style="font-size: 14px;"><%= item.pantone %></span><br />
                                        <% } %>
                <% if (item.hexCode) { %>
                <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                <span style="font-size: 14px;"><%= item.hexCode %></span>
                <% } %>
                <% } else { %>
                -
                                    <% } %>
                                  </td>
                                </tr>
                                <% }); %>
                            </tbody>
                          </table>
                          <% } %>

                            <% if (trims.length> 0) { %>
                              <h3>Trims</h3>
                              <table>
                                <thead>
                                  <tr>
              <th style="width: 10%"><%= t.part || 'Part' %></th>
              <th style="width: 25%"><%= t.materialName || 'Material Name' %></th>
              <th style="width: 15%"><%= t.placement || 'Placement' %></th>
              <th style="width: 10%"><%= t.sizeWidthUsage || 'Size/Width/Usage' %></th>
              <th style="width: 8%"><%= t.qty || 'Qty' %></th>
              <th style="width: 8%"><%= t.uom || 'UOM' %></th>
              <th style="width: 12%"><%= t.supplier || 'Supplier' %></th>
              <th style="width: 16%"><%= t.comments || 'Comments' %></th>
              <th style="width: 10%"><%= t.colorCode || 'Color Code' %></th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <% trims.forEach((item, idx)=> { %>
                                    <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                      <td>
                                        <%= item.part || '-' %>
                                      </td>
                                      <td>
                                        <%= item.materialName || '-' %>
                                      </td>
                                      <td>
                                        <%= item.placement || '-' %>
                                      </td>
                                      <td>
                                        <%= item.sizeWidthUsage || item.size || '-' %>
                                      </td>
                                      <td>
                                        <%= item.quantity || '0' %>
                                      </td>
                                      <td>
                                        <%= item.uom || 'Each' %>
                                      </td>
                                      <td>
                                        <%= item.supplier || '-' %>
                                      </td>
                                      <td>
                                        <%= item.comments || '-' %>
              </td>
              <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                <% if (item.colorCode) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                <% if (item.hexCode) { %><br /><% } %>
                <% } else if (item.color) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                <% if (item.pantone || item.hexCode) { %><br /><% } %>
                                            <% } %>
                <% if (!item.colorCode && item.pantone) { %>
                <span style="font-size: 14px;"><%= item.pantone %></span><br />
                                            <% } %>
                <% if (item.hexCode) { %>
                <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                <span style="font-size: 14px;"><%= item.hexCode %></span>
                <% } %>
                <% } else { %>
                -
                                        <% } %>
                                      </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                              </table>
                              <% } %>

                                <% if (labels.length> 0) { %>
                                  <h3>Labels</h3>
                                  <table>
                                    <thead>
                                      <tr>
              <th style="width: 12%"><%= t.part || 'Part' %></th>
              <th style="width: 28%"><%= t.materialName || 'Material Name' %></th>
              <th style="width: 22%"><%= t.placement || 'Placement' %></th>
              <th style="width: 8%"><%= t.qty || 'Qty' %></th>
              <th style="width: 8%"><%= t.uom || 'UOM' %></th>
              <th style="width: 22%"><%= t.comments || 'Comments' %></th>
              <th style="width: 12%"><%= t.colorCode || 'Color Code' %></th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <% labels.forEach((item, idx)=> { %>
                                        <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                          <td>
                                            <%= item.part || '-' %>
                                          </td>
                                          <td>
                                            <%= item.materialName || '-' %>
                                          </td>
                                          <td>
                                            <%= item.placement || '-' %>
                                          </td>
                                          <td>
                                            <%= item.quantity || '1' %>
                                          </td>
                                          <td>
                                            <%= item.uom || 'Each' %>
                                          </td>
                                          <td>
                                            <%= item.comments || '-' %>
              </td>
              <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                <% if (item.colorCode) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                <% if (item.hexCode) { %><br /><% } %>
                <% } else if (item.color) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                <% if (item.pantone || item.hexCode) { %><br /><% } %>
                                                <% } %>
                <% if (!item.colorCode && item.pantone) { %>
                <span style="font-size: 14px;"><%= item.pantone %></span><br />
                                                <% } %>
                <% if (item.hexCode) { %>
                <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                <span style="font-size: 14px;"><%= item.hexCode %></span>
                <% } %>
                <% } else { %>
                -
                                            <% } %>
                                          </td>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                  </table>
                                  <% } %>

                                    <% if (packaging.length> 0) { %>
                                      <h3>Packaging</h3>
                                      <table>
                                        <thead>
                                          <tr>
              <th style="width: 12%"><%= t.part || 'Part' %></th>
              <th style="width: 28%"><%= t.materialName || 'Material Name' %></th>
              <th style="width: 10%"><%= t.qty || 'Qty' %></th>
              <th style="width: 10%"><%= t.uom || 'UOM' %></th>
              <th style="width: 18%"><%= t.supplier || 'Supplier' %></th>
              <th style="width: 22%"><%= t.comments || 'Comments' %></th>
              <th style="width: 12%"><%= t.colorCode || 'Color Code' %></th>
                                          </tr>
                                        </thead>
                                        <tbody>
                                          <% packaging.forEach((item, idx)=> { %>
                                            <tr class="<%= idx % 2 === 1 ? 'alt-row' : '' %>">
                                              <td>
                                                <%= item.part || '-' %>
                                              </td>
                                              <td>
                                                <%= item.materialName || '-' %>
                                              </td>
                                              <td>
                                                <%= item.quantity || '1' %>
                                              </td>
                                              <td>
                                                <%= item.uom || 'Each' %>
                                              </td>
                                              <td>
                                                <%= item.supplier || '-' %>
                                              </td>
                                              <td>
                                                <%= item.comments || '-' %>
              </td>
              <td style="font-size: 14px; line-height: 1.4; vertical-align: top;">
                <% if (item.colorCode || item.color || item.pantone || item.hexCode) { %>
                <% if (item.colorCode) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.colorCode %></span>
                <% if (item.hexCode) { %><br /><% } %>
                <% } else if (item.color) { %>
                <span style="font-weight: 600; font-size: 14px;"><%= item.color %></span>
                <% if (item.pantone || item.hexCode) { %><br /><% } %>
                                                    <% } %>
                <% if (!item.colorCode && item.pantone) { %>
                <span style="font-size: 14px;"><%= item.pantone %></span><br />
                                                    <% } %>
                <% if (item.hexCode) { %>
                <span style="display:inline-block; width:12px; height:12px; border:1px solid #999; border-radius:2px; background-color:<%= item.hexCode %>; vertical-align:middle; margin-right:4px;"></span>
                <span style="font-size: 14px;"><%= item.hexCode %></span>
                <% } %>
                <% } else { %>
                -
                                                <% } %>
                                              </td>
                                            </tr>
                                            <% }); %>
                                        </tbody>
                                      </table>
                                      <% } %>
                    </div>
                </div>
                <% } %>

                  <%# 3. MEASUREMENTS %>
                    <% if (measurements && measurements.rows && measurements.rows.length> 0) { %>
                      <div class="section">
      <% renderSectionHeader(`${t.measurements || 'Measurements'} - ${t.comments || 'Comments'}`); %>
                          <div class="section-content">
                            <% if (measurements.sizeRange && measurements.sizeRange.length> 0) { %>
        <div style="margin-bottom: 5px">
          <strong><%= t.sizeRange || 'Size Range' %>:</strong>
          <% if (measurements.unit) { %>
          <span style="margin-left: 10px; color: #666; font-weight: normal;">(<%= t.unitLabel || 'Unit' %>: <%= measurements.unit %>)</span>
          <% } %>
          <div style="margin-top: 3px">
            <% const baseSize = measurements.baseSize; %>
                                  <% measurements.sizeRange.forEach(size=> { %>
            <span class="size-badge" style="<%= size === baseSize ? 'background: #79e5a5; color: #000;' : '' %>">
                                      <%= size %>
                                    </span>
                                    <% }); %>
                                </div>
                              </div>
                              <% } %>

                                <div style="overflow-x: auto">
                                  <table class="measurement-table">
                                    <thead>
                                      <tr>
                <th><%= t.pomCode || 'POM Code' %></th>
                <th><%= t.pomName || 'Measurement Point' %></th>
                <th><%= t.minusTolerance || '-Tol' %></th>
                <th><%= t.plusTolerance || '+Tol' %></th>
                                        <% if (measurements.sizeRange) { measurements.sizeRange.forEach(size=> { %>
                                          <th>
                                            <%= size %>
                                          </th>
                                          <% }); } %>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <% measurements.rows.forEach((row, index)=> {
                                        const highlightCodes = ['BL20', 'BL21', 'AB11', 'AB30', 'AB70', 'AH10', 'SL10'];
                                        const shouldHighlight = highlightCodes.some(code =>
                                        row.pomCode?.includes(code));
                                        const baseSize = measurements.baseSize;
                                        %>
              <tr style="<%= shouldHighlight ? 'background: #ffe;' : (index % 2 === 1 ? 'background: #e8e8e8;' : '') %>">
                                          <td>
                                            <%= row.pomCode || '-' %>
                                          </td>
                                          <td>
                                            <%= row.pomName || '-' %>
                                          </td>
                                          <td>
                  <%= row.minusToleranceFormatted || (row.minusTolerance !== undefined ? row.minusTolerance : '0') %>
                                          </td>
                                          <td>
                  <%= row.plusToleranceFormatted || (row.plusTolerance !== undefined ? row.plusTolerance : '0') %>
                                          </td>
                                          <% if (measurements.sizeRange) { measurements.sizeRange.forEach(size=> { %>
                                            <td style="<%= size === baseSize ? 'background: #79e5a5;' : '' %>">
                                              <%= row.sizes?.[size] || '-' %>
                                            </td>
                                            <% }); } %>
                                        </tr>
                                        <% }); %>
                                    </tbody>
                                  </table>
                                </div>

                                <% if (measurements.notes || measurements.comments) { %>
                                  <div class="notes">
          <strong><%= t.notesLabel || t.notes || 'Notes' %>:</strong>
                                    <%= measurements.notes || measurements.comments %>
                                  </div>
                                  <% } %>
                          </div>
                      </div>
                      <% } %>

                        <%# 3B. SAMPLE MEASUREMENT ROUNDS %>
                          <% if (sampleMeasurementRounds && sampleMeasurementRounds.length> 0) { %>
                            <% sampleMeasurementRounds.forEach((round, roundIndex)=> { %>
                              <div class="section">
      <% renderSectionHeader(`${t.sampleMeasurements || 'Sample Measurements'} - ${round.name}`); %>
          <div class="section-content">
        <div class="info-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 5px">
              <div class="info-item">
            <strong><%= t.measurementDate || 'Measurement Date' %></strong>
                <span><%= round.measurementDate || ' -' %></span>
                              </div>
                              <div class="info-item">
            <strong><%= t.reviewer || 'Reviewer' %></strong>
                                <span>
                                  <%= round.reviewer || '-' %>
                                </span>
                              </div>

  </div>

  <% if (round.measurements && round.measurements.length> 0) { %>
    <div style="overflow-x: auto">
          <table class="measurement-table" style="font-size: 14px">
        <thead>
          <tr>
                <th style="width: 8%"><%= t.pom || 'POM' %></th>
                <th style="width: 12%"><%= t.point || 'Point' %></th>
                <th style="width: 5%"><%= t.minusTolerance || '-Tol' %></th>
                <th style="width: 5%"><%= t.plusTolerance || '+Tol' %></th>
                <th style="width: 10%"><%= t.requested || 'Requested' %></th>
                <th style="width: 8%"><%= t.measured || 'Measured' %></th>
                <th style="width: 7%"><%= t.diff || 'Diff' %></th>
                <th style="width: 8%"><%= t.revised || 'Revised' %></th>
                <th style="width: 37%"><%= t.comments || 'Comments' %></th>
          </tr>
        </thead>
        <tbody>
          <% round.measurements.forEach((entry, idx)=> { %>
            <tr style="<%= idx % 2 === 1 ? 'background: #e8e8e8;' : '' %>">
              <td>
                <%= entry.pomCode || '-' %>
              </td>
              <td style="text-align: left">
                <%= entry.pomName || '-' %>
              </td>
              <td>
                  <%= entry.toleranceMinusFormatted || entry.toleranceMinus || '0' %>
              </td>
              <td>
                  <%= entry.tolerancePlusFormatted || entry.tolerancePlus || '0' %>
              </td>
              <td>
                <% const baseSize=measurements?.baseSize || 'M' ; %>
                  <%= entry.requested?.[baseSize] || '-' %>
              </td>
              <td>
                <%= entry.measured?.[baseSize] || '-' %>
              </td>
                <td style="
                  white-space: nowrap;
                  word-break: normal;
                  overflow-wrap: normal;
                  <%= parseFloat(entry.diffDisplay?.[baseSize] || 0) > 0 ? 'color: red; font-weight: bold;' : '' %>
                ">
                  <%= entry.diffDisplay?.[baseSize] || '-' %>
              </td>
              <td>
                <%= entry.revised?.[baseSize] || '-' %>
              </td>
                <td style="text-align: left; font-size: 14px">
                <%= entry.comments?.[baseSize] || '-' %>
              </td>
            </tr>
            <% }); %>
        </tbody>
      </table>
    </div>
    <% } %>
      <% if (round.overallComments && round.overallComments !=='—' ) { %>
        <div class="notes" style="margin-top: 5px; page-break-before: avoid !important; page-break-inside: avoid;">
          <strong>OVERALL COMMENTS:</strong>
          <%- round.overallComments %>
        </div>
        <% } %>
          <% if (round.editorContent && round.editorContent.trim() !=='' ) { %>
        <div class="notes" style="margin-top: 5px; page-break-before: avoid !important; page-break-inside: avoid;">
              <strong>DETAILS:</strong>
              <%- round.editorContent %>
            </div>
            <% } %>
              </div>
              </div>
              <% }); %>
                <% } %>

    <%# 4. COLORWAYS - LUÔN bắt đầu ở trang mới, không được chia cắt, và LUÔN kết thúc bằng ngắt trang %>
                    <% if (colorways && colorways.length> 0) { %>
    <div class="section section--colorways" style="page-break-before: always !important; page-break-inside: avoid !important; page-break-after: always !important;">
      <% renderSectionHeader(t.colorways || 'Colorways'); %>
      <div class="section-content" style="page-break-inside: avoid !important; page-break-after: avoid !important;">
        <div class="colorways-grid" style="page-break-inside: avoid !important; page-break-after: avoid !important;">
                              <% colorways.forEach(color=> { %>
          <div class="colorway-card" style="page-break-inside: avoid !important;">
            <div class="colorway-card-text">
              <div class="colorway-card-title">
                                    <%= color.name || 'Color' %>
              </div>
              <div class="colorway-card-code">
                <%= t.code || 'Code' %>: <%= color.code || '000' %>
              </div>
            </div>
            <% if (color.imageUrl && color.imageUrl !== '—' && !color.imageUrl.includes('No Image')) { %>
            <div class="colorway-card-image" style="page-break-inside: avoid !important;">
              <img src="<%= color.imageUrl %>" alt="Colorway Image" />
            </div>
                                          <% } %>
                                </div>
                                <% }); %>
                            </div>
                          </div>
                      </div>
                      <% } %>

    <%# 5. CONSTRUCTION - Mỗi construction = 1 trang, header lặp lại mỗi trang, ảnh không được tràn %>
    <% 
      function splitByLines(text, maxLines) {
        const lines = String(text || '').replace(/\r\n/g, '\n').split('\n');
        const chunks = [];
        for (let i = 0; i < lines.length; i += maxLines) {
          chunks.push(lines.slice(i, i + maxLines).join('\n'));
        }
        return chunks.filter(c => c.trim().length > 0);
      }

      // 10% page ~ 4 dòng với font 14px; có thể chỉnh nếu cần
      const NOTE_MAX_LINES_ON_IMAGE_PAGE = 4;
    %>
                          <% if (howToMeasures && howToMeasures.length> 0) { %>
                                  <% howToMeasures.forEach((item, index)=> { %>
    <%# Mỗi construction item LUÔN bắt đầu ở trang mới (kể cả item đầu tiên) %>
    <div class="section construction-item" style="page-break-before: always !important; page-break-inside: avoid !important; page-break-after: always !important;">
      <%# Header lặp lại trên MỖI TRANG - không được break với content %>
      <div style="page-break-inside: avoid !important; page-break-after: avoid !important; margin-bottom: 5px;">
        <% renderSectionHeader(t.constructionDetails || t.howToMeasure || 'Construction Details'); %>
      </div>

      <div class="construction-content" style="page-break-inside: avoid !important; page-break-after: avoid !important; page-break-before: avoid !important; display: flex; flex-direction: column; flex: 1; min-height: 0;">
        <!-- Image Section - Hiển thị trước, chiếm tối đa không gian còn lại -->
        <% if (item.imageUrl) { %>
        <div class="construction-image-wrapper" style="page-break-inside: avoid !important; page-break-after: avoid !important; page-break-before: avoid !important; flex: 1 1 auto; min-height: 0; display: flex; align-items: center; justify-content: center;">
          <img src="<%= item.imageUrl %>" alt="<%= item.pomName || 'Construction' %>" class="construction-image" style="page-break-inside: avoid !important; width: 100%; height: 100%; object-fit: contain;" />
        </div>
        <% } else { %>
        <div class="construction-image-wrapper" style="background: #f9f9f9; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; page-break-inside: avoid !important; page-break-after: avoid !important;">
          <span style="color: #999; font-size: 14px;"><%= t.noImage || 'No Image' %></span>
        </div>
                                            <% } %>

        <!-- Text Content Section - Hiển thị sau -->
        <%
          const stepNo = item.stepNumber || (index + 1);
          const titleBase = (item.pomName && item.pomName !== '—') ? item.pomName : 'Construction';
          const noteRaw = (item.note && item.note !== '—') ? String(item.note) : '';
          const noteText = noteRaw.replace(/\r\n/g, '\n').trim();
          const noteChunks = noteText ? splitByLines(noteText, NOTE_MAX_LINES_ON_IMAGE_PAGE) : [];
          const firstChunk = noteChunks.length ? noteChunks[0] : '';
          const remainingChunks = noteChunks.length > 1 ? noteChunks.slice(1) : [];
        %>
        <div class="construction-text" style="page-break-inside: avoid !important; page-break-after: avoid !important; flex-shrink: 0; flex-grow: 0;">
          <% if (noteText) { %>
            <div class="construction-note"><%= firstChunk %></div>
                                                <% } %>

          <% if (item.steps && item.steps.length > 0) { %>
          <div class="construction-section">
            <strong class="construction-label"><%= (t.steps || 'Steps') + ':' %></strong>
            <ol class="construction-list">
              <% item.steps.forEach(step => { %>
              <li><%= step %></li>
                                                          <% }); %>
                                                      </ol>
                                                    </div>
                                                    <% } %>
          <% if (item.tips && item.tips.length > 0) { %>
          <div class="construction-tips">
            <strong>💡 <%= t.tips || 'Tips' %>:</strong>
            <ul class="construction-list">
              <% item.tips.forEach(tip => { %>
              <li><%= tip %></li>
                                                              <% }); %>
                                                          </ul>
                                                        </div>
                                                        <% } %>
          <% if (item.commonMistakes && item.commonMistakes.length > 0) { %>
          <div class="construction-mistakes">
            <strong>⚠️ <%= t.commonMistakes || 'Common Mistakes' %>:</strong>
            <ul class="construction-list">
              <% item.commonMistakes.forEach(mistake => { %>
              <li><%= mistake %></li>
                                                                  <% }); %>
                                                              </ul>
                                                            </div>
                                                            <% } %>
                                        </div>
                                          </div>
                                      </div>

    <% if (noteText && remainingChunks.length > 0) { %>
      <% remainingChunks.forEach((chunk, ci) => { %>
        <div class="section construction-notes-page">
          <div style="page-break-inside: avoid !important; page-break-after: avoid !important; margin-bottom: 5px;">
            <% renderSectionHeader(t.constructionDetails || t.howToMeasure || 'Construction Details'); %>
                                    </div>

          <div class="construction-notes-content">
            <div class="construction-note"><%= chunk %></div>
                                </div>
                            </div>
      <% }); %>
    <% } %>
    <% }); %>
                            <% } %>

    <%# 6. PACKING - Mỗi packing item = 1 trang, layout: ảnh trên (90%), chữ dưới (10%) %>
                                <% if (packingNotes && packingNotes !=='—' ) { %>
      <%# Parse packingNotes HTML để tách từng .packing-layout item - FIX: dùng parser đếm thẻ div đúng cách %>
      <% 
        function extractDivBlocksByClass(html, className) {
          const blocks = [];
          if (!html) return blocks;

          const openRe = new RegExp('<div\\s+[^>]*class=["\'][^"\']*\\b' + className + '\\b[^"\']*["\'][^>]*>', 'gi');
          let m;

          while ((m = openRe.exec(html)) !== null) {
            const start = m.index;
            let i = openRe.lastIndex;
            let depth = 1;

            while (i < html.length && depth > 0) {
              const nextOpen = html.indexOf('<div', i);
              const nextClose = html.indexOf('</div', i);

              if (nextClose === -1) break;

              if (nextOpen !== -1 && nextOpen < nextClose) {
                depth++;
                i = nextOpen + 4;
              } else {
                depth--;
                const closeEnd = html.indexOf('>', nextClose);
                if (closeEnd === -1) break;
                i = closeEnd + 1;
              }
            }

            blocks.push(html.slice(start, i));
            openRe.lastIndex = i; // continue after this block
          }

          return blocks;
        }

        const packingItems = extractDivBlocksByClass(packingNotes, 'packing-layout');
        if (packingItems.length === 0) packingItems.push(packingNotes);
      %>
      <% packingItems.forEach((itemHtml, index) => { %>
        <%# Mỗi packing item LUÔN bắt đầu ở trang mới (trừ item đầu tiên để tránh trang trống) %>
        <% const breakBefore = index === 0 ? 'auto' : 'always'; %>
        <div class="section pp packing-item" style="page-break-before: <%= breakBefore %> !important; page-break-inside: avoid !important; page-break-after: always !important;">
          <%# Header lặp lại trên MỖI TRANG %>
          <div style="page-break-inside: avoid !important; page-break-after: avoid !important; margin-bottom: 5px;">
            <% renderSectionHeader(t.labelsPacking || 'Labels - Packing'); %>
                                        </div>
          <div class="section-content" style="display: flex; flex-direction: column; flex: 1; min-height: 0;">
            <div style="display: flex; flex-direction: column; flex: 1; min-height: 0; background: #f8fafc; border: 1px solid #e1e7ee; border-radius: 6px; padding: 12px;">
              <%- itemHtml %>
                                      </div>
                                  </div>
        </div>
      <% }); %>
                                  <% } %>

                                        </div>

  <!-- Footer - Fixed at bottom of every page -->
  <!-- NOTE: Footer này chỉ hiển thị khi KHÔNG dùng Puppeteer footerTemplate -->
  <!-- Khi dùng footerTemplate, footer này sẽ bị ẩn bằng CSS -->
  <div class="pdf-footer" id="html-footer" style="display: none;">
    <div class="pdf-footer__left">
      <%= (t.createdBy || 'Created by') + ': ' %><%= meta.technicalDesignerId || meta.designer || meta.technicalDesigner || 'Technical Designer' %>
                                                  </div>
    <div class="pdf-footer__center">
      <%= (t.byLabel || 'By') + ': ' %>iBC connecting
                                                </div>
    <div class="pdf-footer__right">
      <%= t.page || 'Page' %> <span class="page-number">-</span> / <span class="total-pages">-</span>
                                                </div>
                                              </div>

  <!-- Script để xử lý anti-waste: scale ảnh khi trang còn trống >40% -->
  <script>
    (function() {
      'use strict';

      // Thông số
      // WASTE_THRESHOLD = 40% của phần CONTENT KHẢ DỤNG (đã trừ header, footer, margins)
      // KHÔNG phải 40% của toàn bộ trang
      const WASTE_THRESHOLD = 0.4; // 40% của USABLE_CONTENT_HEIGHT
      const MIN_SCALE = 0.25; // Tối thiểu 25% kích thước gốc

      // Định nghĩa rõ USABLE CONTENT HEIGHT
      // A4 portrait: width=210mm, height=297mm
      // 1mm ≈ 3.7795px ở 96dpi
      const PAGE_HEIGHT_MM = 297; // A4 portrait height
      const MM_TO_PX = 3.7795;
      const PAGE_HEIGHT_PX = PAGE_HEIGHT_MM * MM_TO_PX; // ~1123px

      // Header, Footer, Margins
      const HEADER_HEIGHT = 120; // 120px cho header
      const FOOTER_HEIGHT = 76; // 76px cho footer (≈20mm)
      const PAGE_MARGIN_TOP = 4; // 4mm
      const PAGE_MARGIN_BOTTOM = 15; // 15mm
      const MARGINS_TOTAL = (PAGE_MARGIN_TOP + PAGE_MARGIN_BOTTOM) * MM_TO_PX; // ~72px

      // USABLE CONTENT HEIGHT = Tổng chiều cao trang - Header - Footer - Margins
      // ≈ 1123px - 120px - 76px - 72px ≈ 855px (100%)
      // Nhưng với A4 landscape (210mm height), ta dùng:
      const PAGE_HEIGHT_MM_LANDSCAPE = 210; // A4 landscape height
      const PAGE_HEIGHT_PX_LANDSCAPE = PAGE_HEIGHT_MM_LANDSCAPE * MM_TO_PX; // ~794px
      const USABLE_CONTENT_HEIGHT = PAGE_HEIGHT_PX_LANDSCAPE - HEADER_HEIGHT - FOOTER_HEIGHT - MARGINS_TOTAL; // ~526px

       // Debug log (tắt mặc định để tăng tốc export)
       const ANTI_WASTE_DEBUG = false;
       const awLog = (...args) => { if (ANTI_WASTE_DEBUG) console.log(...args); };
       const awWarn = (...args) => { if (ANTI_WASTE_DEBUG) console.warn(...args); };

       awLog('[Anti-waste] Page calculations:', {
         pageHeightPx: PAGE_HEIGHT_PX_LANDSCAPE.toFixed(0) + 'px',
         headerHeight: HEADER_HEIGHT + 'px',
         footerHeight: FOOTER_HEIGHT + 'px',
         margins: MARGINS_TOTAL.toFixed(0) + 'px',
         usableContentHeight: USABLE_CONTENT_HEIGHT.toFixed(0) + 'px (100%)',
         wasteThreshold40pct: (USABLE_CONTENT_HEIGHT * WASTE_THRESHOLD).toFixed(0) + 'px (40%)'
       });

      // Giữ PAGE_USABLE_HEIGHT cho backward compatibility
      const PAGE_USABLE_HEIGHT = USABLE_CONTENT_HEIGHT;

      /**
       * Tính metrics của trang tại vị trí docY
       */
      function getPageMetricsForY(docY) {
        const pageIndex = Math.floor(docY / PAGE_HEIGHT_PX_LANDSCAPE);
        const pageTop = pageIndex * PAGE_HEIGHT_PX_LANDSCAPE;

        const usableTop = pageTop + (PAGE_MARGIN_TOP * MM_TO_PX) + HEADER_HEIGHT;
        const usableBottom = pageTop + PAGE_HEIGHT_PX_LANDSCAPE - (PAGE_MARGIN_BOTTOM * MM_TO_PX) - FOOTER_HEIGHT;

        // Sử dụng USABLE_CONTENT_HEIGHT thay vì tính lại
        const pageUsableHeight = USABLE_CONTENT_HEIGHT;
        return {
          pageIndex,
          pageTop,
          usableTop,
          usableBottom,
          pageUsableHeight
        };
      }

      /**
       * Tính docY từ rect.top
       */
      function getDocYFromRectTop(rectTop) {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop || 0;
        return rectTop + scrollTop;
      }

      /**
       * Tính fillableNow đúng nghĩa (và xử lý case ảnh bị đẩy sang trang mới)
       */
      function getFillableNowForImage(img) {
        const imgRect = img.getBoundingClientRect();
        const imgTopDocY = getDocYFromRectTop(imgRect.top);
        const imgMetrics = getPageMetricsForY(imgTopDocY);

        // Ảnh đang ở "đầu trang" => có khả năng bị page-break từ trang trước
        const imgTopInPage = imgTopDocY - imgMetrics.pageTop;
        const isNearTopOfPage = imgTopInPage < (PAGE_MARGIN_TOP * MM_TO_PX + HEADER_HEIGHT + 80); // 80px tolerance

        if (!isNearTopOfPage) {
          // Bình thường: fillable của chính trang ảnh đang đứng
          const cursorY = Math.max(imgTopDocY, imgMetrics.usableTop);
          const fillableNow = Math.max(0, imgMetrics.usableBottom - cursorY);
          const wasteRatio = fillableNow / USABLE_CONTENT_HEIGHT;

           awLog('[Anti-waste] getRemainingHeight:', {
            remainingHeight: fillableNow.toFixed(0) + 'px',
            usableContentHeight: USABLE_CONTENT_HEIGHT.toFixed(0) + 'px',
            wasteRatio: (wasteRatio * 100).toFixed(1) + '%',
            threshold: (WASTE_THRESHOLD * 100) + '%',
            action: wasteRatio > WASTE_THRESHOLD ? '✅ WILL SCALE (waste > threshold)' : '⚠️ ALLOW PAGE BREAK (waste <= threshold)'
          });

          return {
            fillableNow: fillableNow,
            metrics: imgMetrics,
            fromPrevPage: false
          };
        }

        // Nếu ảnh ở gần đầu trang => tính fillable của TRANG TRƯỚC theo phần tử ngay trước ảnh
        const prev = img.previousElementSibling || img.parentElement?.previousElementSibling;
        if (!prev) {
          // Fallback: vẫn dùng trang hiện tại
          const cursorY = Math.max(imgTopDocY, imgMetrics.usableTop);
          const fillableNow = Math.max(0, imgMetrics.usableBottom - cursorY);
          return {
            fillableNow: fillableNow,
            metrics: imgMetrics,
            fromPrevPage: false
          };
        }

        const prevRect = prev.getBoundingClientRect();
        const prevBottomDocY = getDocYFromRectTop(prevRect.bottom);

        // prevBottom nằm ở trang trước (thường vậy). Nếu không, vẫn fallback.
        const prevMetrics = getPageMetricsForY(prevBottomDocY);
        const prevCursorY = Math.min(Math.max(prevBottomDocY, prevMetrics.usableTop), prevMetrics.usableBottom);

        const fillablePrev = Math.max(0, prevMetrics.usableBottom - prevCursorY);
        const wasteRatio = fillablePrev / USABLE_CONTENT_HEIGHT;

         awLog('[Anti-waste] Image near top of page, using previous page fillable:', {
          imgTopInPage: imgTopInPage.toFixed(0) + 'px',
          prevBottomDocY: prevBottomDocY.toFixed(0) + 'px',
          fillablePrev: fillablePrev.toFixed(0) + 'px',
          usableContentHeight: USABLE_CONTENT_HEIGHT.toFixed(0) + 'px',
          wasteRatio: (wasteRatio * 100).toFixed(1) + '%',
          threshold: (WASTE_THRESHOLD * 100) + '%',
          action: wasteRatio > WASTE_THRESHOLD ? '✅ WILL SCALE (waste > threshold)' : '⚠️ ALLOW PAGE BREAK (waste <= threshold)'
        });

        return {
          fillableNow: fillablePrev,
          metrics: prevMetrics,
          fromPrevPage: true,
          prevEl: prev
        };
      }

      /**
       * Scale ảnh để vừa fillableNow
       */
      function scaleImageToFit(img, fillableNow, pageUsableHeight, fromPrevPage) {
        if (!img.complete || !img.naturalWidth || !img.naturalHeight) {
          // Ảnh chưa load, đợi load xong - nhưng không thể truyền lại fillableNow
          // Nên sẽ được gọi lại từ processContentImages sau khi ảnh load
          return;
        }

        const container = img.parentElement;
        const containerWidth = container ? container.clientWidth : img.parentElement.clientWidth || 800;
        const maxRenderWidth = containerWidth * 0.95; // 95% của container width

        // Tính chiều cao ảnh ở maxRenderWidth
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        const imgHeightAtMaxWidth = maxRenderWidth / aspectRatio;

        // Case 1: Ảnh fit bình thường - vẫn ép scale để tận dụng không gian
        if (imgHeightAtMaxWidth <= fillableNow) {
          // Tính scale để ảnh chiếm hết fillableNow nếu có thể
          const scaleToFill = Math.min(1, fillableNow / imgHeightAtMaxWidth);
          const finalWidth = maxRenderWidth * scaleToFill;
          const finalHeight = imgHeightAtMaxWidth * scaleToFill;
          
          img.style.width = finalWidth + 'px';
          img.style.height = finalHeight + 'px';
          img.style.maxWidth = 'none';
          img.style.maxHeight = 'none';
          img.style.objectFit = 'contain';
          return;
        }

        // Case 2: Ảnh không fit - tính scale
        const scaleToFit = fillableNow / imgHeightAtMaxWidth;

        // Tính wasteRatio dựa trên USABLE_CONTENT_HEIGHT
        // Waste Ratio = Remaining Height / USABLE CONTENT HEIGHT
        const wasteRatio = fillableNow / USABLE_CONTENT_HEIGHT;

        // Debug log chi tiết
         awLog('[Anti-waste] Waste calculation:', {
          remainingHeight: fillableNow.toFixed(0) + 'px',
          usableContentHeight: USABLE_CONTENT_HEIGHT.toFixed(0) + 'px',
          wasteRatio: (wasteRatio * 100).toFixed(1) + '%',
          threshold: (WASTE_THRESHOLD * 100) + '%',
          shouldScale: wasteRatio > WASTE_THRESHOLD
        });

        if (wasteRatio > WASTE_THRESHOLD) {
          // BẮT BUỘC scale để vừa fillableNow - KHÔNG QUAN TÂM minScale
          // Vì wasteRatio > 0.4 (40% của phần content khả dụng) nghĩa là trang còn nhiều khoảng trống, phải scale để tận dụng
          const renderWidth = maxRenderWidth * scaleToFit;
          const renderHeight = fillableNow;

          // Tính waste ratio sau khi scale (ước tính)
          const estimatedNewWaste = Math.max(0, USABLE_CONTENT_HEIGHT - fillableNow - (imgHeightAtMaxWidth * scaleToFit)) / USABLE_CONTENT_HEIGHT;

          // ÉP ảnh scale bằng width/height px thay vì maxWidth/maxHeight
          img.style.width = renderWidth + 'px';
          img.style.height = renderHeight + 'px';
          img.style.maxWidth = 'none';
          img.style.maxHeight = 'none';
          img.style.objectFit = 'contain';
          img.style.pageBreakBefore = 'avoid'; // QUAN TRỌNG: không được page-break
          img.style.pageBreakInside = 'avoid';
          img.style.display = 'block';
          img.style.margin = '0';

           awLog('[Anti-waste] ✅✅✅ FORCED SCALE (waste=' + (wasteRatio * 100).toFixed(1) + '% > 40%):', {
            originalSize: img.naturalWidth + 'x' + img.naturalHeight,
            scaledSize: renderWidth.toFixed(0) + 'x' + renderHeight.toFixed(0),
            scaleRatio: scaleToFit.toFixed(2) + 'x',
            wasteReduction: 'From ' + (wasteRatio * 100).toFixed(1) + '% to ~' + (estimatedNewWaste * 100).toFixed(1) + '%',
            action: '🎯 SCALED TO FIT - NO PAGE BREAK'
          });
        } else {
          // Rule B: wasteRatio <= 0.4, cho phép page-break
          // Vẫn dùng width/height để đảm bảo ảnh scale đúng
          img.style.width = maxRenderWidth + 'px';
          img.style.height = 'auto';
          img.style.maxWidth = 'none';
          img.style.maxHeight = 'none';
          img.style.pageBreakBefore = 'auto';

           awLog('[Anti-waste] ⚠️ ALLOW PAGE BREAK (wasteRatio <= 40%):', {
            wasteRatio: (wasteRatio * 100).toFixed(1) + '%',
            fillableNow: fillableNow.toFixed(0) + 'px',
            usableContentHeight: USABLE_CONTENT_HEIGHT.toFixed(0) + 'px',
            action: 'ALLOW PAGE BREAK'
          });
        }
      }

      /**
       * Xử lý tất cả ảnh content
       */
      function processContentImages() {
        // Tìm tất cả ảnh trong construction, notes, nhưng BỎ QUA phần Packing (.pp)
        // vì Packing cần export đúng y như nội dung người dùng nhập (không auto-scale).
        const contentImages = document.querySelectorAll(
          '.notes img'
        );

         awLog('[Anti-waste] Found', contentImages.length, 'content images to process');

        // Debug: log tất cả ảnh được tìm thấy
        if (contentImages.length > 0) {
          contentImages.forEach(function(img, idx) {
            const src = img.src || img.getAttribute('src') || 'no src';
            const parent = img.parentElement ? img.parentElement.className : 'no parent';
             awLog('[Anti-waste] Image', idx + 1, '- src:', src.substring(0, 50), 'parent:', parent);
          });
        }

        if (contentImages.length === 0) {
           awWarn('[Anti-waste] No content images found!');
          return;
        }

        contentImages.forEach(function(img, index) {
          // Bỏ qua ảnh đã được xử lý (có data attribute)
          if (img.dataset.antiWasteProcessed === 'true') {
            return;
          }

          // Đánh dấu đã xử lý
          img.dataset.antiWasteProcessed = 'true';

          // Đợi ảnh load xong
          if (img.complete && img.naturalWidth > 0 && img.naturalHeight > 0) {
            // Delay nhỏ để đảm bảo layout đã ổn định
            setTimeout(function() {
              const info = getFillableNowForImage(img);
              const fillableNow = info.fillableNow;
              // Waste Ratio = Remaining Height / USABLE CONTENT HEIGHT
              const wasteRatio = fillableNow / USABLE_CONTENT_HEIGHT;

               awLog('[Anti-waste] Image', index + 1, '- fillableNow:', fillableNow.toFixed(0), 'px, usableContentHeight:', USABLE_CONTENT_HEIGHT.toFixed(0), 'px, wasteRatio:', (wasteRatio * 100).toFixed(1) + '%', info.fromPrevPage ? '(from prev page)' : '');

              // Nếu fillableNow nằm ở trang trước và >40% của phần content khả dụng => ép ảnh "được phép kéo lên"
              if (info.fromPrevPage && wasteRatio > WASTE_THRESHOLD) {
                // Ép wrapper/ảnh tránh break trước nó
                const wrapper = img.parentElement || img;
                wrapper.style.breakBefore = 'avoid';
                wrapper.style.pageBreakBefore = 'avoid';
                img.style.breakBefore = 'avoid';
                img.style.pageBreakBefore = 'avoid';
                 awLog('[Anti-waste] ✅ Forced break-before: avoid to pull image up');
              }

              scaleImageToFit(img, fillableNow, USABLE_CONTENT_HEIGHT, info.fromPrevPage);
            }, 50);
          } else {
            // Đợi ảnh load
            const loadHandler = function() {
              setTimeout(function() {
                const info = getFillableNowForImage(img);
                const fillableNow = info.fillableNow;
                // Waste Ratio = Remaining Height / USABLE CONTENT HEIGHT
                const wasteRatio = fillableNow / USABLE_CONTENT_HEIGHT;

                 awLog('[Anti-waste] Image', index + 1, '(loaded) - fillableNow:', fillableNow.toFixed(0), 'px, usableContentHeight:', USABLE_CONTENT_HEIGHT.toFixed(0), 'px, wasteRatio:', (wasteRatio * 100).toFixed(1) + '%', info.fromPrevPage ? '(from prev page)' : '');

                // Nếu fillableNow nằm ở trang trước và >40% của phần content khả dụng => ép ảnh "được phép kéo lên"
                if (info.fromPrevPage && wasteRatio > WASTE_THRESHOLD) {
                  // Ép wrapper/ảnh tránh break trước nó
                  const wrapper = img.parentElement || img;
                  wrapper.style.breakBefore = 'avoid';
                  wrapper.style.pageBreakBefore = 'avoid';
                  img.style.breakBefore = 'avoid';
                  img.style.pageBreakBefore = 'avoid';
                   awLog('[Anti-waste] ✅ Forced break-before: avoid to pull image up');
                }

                scaleImageToFit(img, fillableNow, USABLE_CONTENT_HEIGHT, info.fromPrevPage);
              }, 50);
              img.removeEventListener('load', loadHandler);
            };
            img.addEventListener('load', loadHandler);

            // Fallback: nếu ảnh không load được sau 2s, xử lý với kích thước mặc định
            setTimeout(function() {
              if (!img.complete || img.naturalWidth === 0) {
                 awWarn('[Anti-waste] Image', index + 1, 'not loaded after 2s, using default size');
                img.style.maxHeight = '600px';
              }
            }, 2000);
          }
        });
      }

      // Expose function globally để Puppeteer có thể gọi
      window.processAntiWasteImages = processContentImages;

      // Chạy khi DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
           awLog('[Anti-waste] DOMContentLoaded - scheduling processContentImages');
          setTimeout(processContentImages, 300);
        });
      } else {
         awLog('[Anti-waste] DOM already ready - scheduling processContentImages');
        setTimeout(processContentImages, 300);
      }

      // Chạy lại sau khi tất cả ảnh load xong (quan trọng cho Puppeteer)
      window.addEventListener('load', function() {
         awLog('[Anti-waste] Window load event - scheduling processContentImages');
        setTimeout(processContentImages, 800);
      });

      // Chạy lại nhiều lần để đảm bảo layout đã ổn định (quan trọng cho Puppeteer)
      setTimeout(function() {
         awLog('[Anti-waste] First delayed run (800ms)');
        processContentImages();
      }, 800);

      setTimeout(function() {
         awLog('[Anti-waste] Second delayed run (1500ms)');
        processContentImages();
      }, 1500);

      setTimeout(function() {
         awLog('[Anti-waste] Third delayed run (2500ms)');
        processContentImages();
      }, 2500);

      setTimeout(function() {
         awLog('[Anti-waste] Fourth delayed run (3500ms)');
        processContentImages();
      }, 3500);

      // Retry logic: nếu vẫn còn ảnh chưa được xử lý, retry
      setTimeout(function() {
         const unprocessedImages = document.querySelectorAll(
           '.notes img'
         );
        let unprocessedCount = 0;
        unprocessedImages.forEach(function(img) {
          if (!img.dataset.antiWasteProcessed) {
            unprocessedCount++;
          }
        });
        if (unprocessedCount > 0) {
           awLog('[Anti-waste] Retrying for', unprocessedCount, 'unprocessed images');
          processContentImages();
        }
      }, 3000);

      // Sử dụng MutationObserver để xử lý ảnh được thêm động
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              if (node.tagName === 'IMG' && node.complete && node.naturalWidth > 0) {
                const info = getFillableNowForImage(node);
                const fillableNow = info.fillableNow;
                const wasteRatio = fillableNow / info.metrics.pageUsableHeight;

                if (info.fromPrevPage && wasteRatio > WASTE_THRESHOLD) {
                  const wrapper = node.parentElement || node;
                  wrapper.style.breakBefore = 'avoid';
                  wrapper.style.pageBreakBefore = 'avoid';
                  node.style.breakBefore = 'avoid';
                  node.style.pageBreakBefore = 'avoid';
                }

                scaleImageToFit(node, fillableNow, info.metrics.pageUsableHeight, info.fromPrevPage);
              } else {
                const images = node.querySelectorAll && node.querySelectorAll('img');
                if (images) {
                  images.forEach(function(img) {
                    if (img.complete && img.naturalWidth > 0) {
                      const info = getFillableNowForImage(img);
                      const fillableNow = info.fillableNow;
                      const wasteRatio = fillableNow / info.metrics.pageUsableHeight;

                      if (info.fromPrevPage && wasteRatio > WASTE_THRESHOLD) {
                        const wrapper = img.parentElement || img;
                        wrapper.style.breakBefore = 'avoid';
                        wrapper.style.pageBreakBefore = 'avoid';
                        img.style.breakBefore = 'avoid';
                        img.style.pageBreakBefore = 'avoid';
                      }

                      scaleImageToFit(img, fillableNow, info.metrics.pageUsableHeight, info.fromPrevPage);
                    }
                  });
                }
              }
            }
          });
        });
      });

      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    })();
  </script>

</body>

</html>